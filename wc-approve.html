<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>Approve USDT через WalletConnect</title>
  <!-- Подключаем Telegram WebApp SDK (опционально для дебага в браузере) -->
  <script async src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; }
    #qr { width: 100%; height: auto; margin-top: 16px; }
    #status { margin: 16px; text-align: center; }
    button { display: block; margin: 16px auto; padding: 8px 16px; }
  </style>
</head>
<body>
  <div id="status">Инициализация...</div>
  <div style="text-align: center;">
    <img id="qr" src="" alt="QR код WalletConnect" />
  </div>
  <button id="cancelBtn">Отменить</button>

  <script>
    // 1) Проверка, запущено ли из Telegram
    if (!window.Telegram || !window.Telegram.WebApp) {
      document.getElementById('status').innerText =
        'Ошибка: WebApp API не доступен. Откройте этот WebApp через Telegram‑бота.';
      // Больше ничего не делаем
      throw new Error('WebApp API not available');
    }

    // 2) Telegram.WebApp готов к работе
    Telegram.WebApp.ready();
    Telegram.WebApp.expand(); // можно расширить под весь экран

    // 3) Чтение параметров из Telegram.WebApp.initData или initDataUnsafe
    const initDataUnsafe = Telegram.WebApp.initDataUnsafe || {};
    // Например, можно получить chat_id в Telegram.WebApp.initDataUnsafe.peer_id, 
    // но обычно initDataUnsafe присылает user и др. параметры.

    const statusDiv = document.getElementById('status');
    const qrImg = document.getElementById('qr');
    const cancelBtn = document.getElementById('cancelBtn');

    // 4) Здесь вы должны вызвать свою логику WalletConnect (JS‑библиотеку),
    // получить URI и отобразить QR‑код.
    // Для примера приведу заглушку:
    async function startWalletConnect() {
      statusDiv.innerText = 'Генерируем URI через WalletConnect…';
      try {
        // допустим, у вас есть функция walletConnectConnect(), возвращающая объект {uri, approval}
        // const { uri, approval } = await walletConnectConnect();
        // Для демонстрации используем фиктивный URI:
        const uri = 'wc:xxx@2?relay-protocol=irn&symKey=yyy';
        qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(uri)}`;
        statusDiv.innerText = 'Сканируйте QR‑код для Approve транзакции.';
        // Ждём, пока approval() завершится, и сообщаем Telegram о закрытии:
        // await approval();
        // Telegram.WebApp.close();
      } catch (err) {
        statusDiv.innerText = 'Ошибка WalletConnect: ' + err.message;
      }
    }

    startWalletConnect();

    // 5) Кнопка «Отменить» закрывает WebApp
    cancelBtn.addEventListener('click', () => {
      Telegram.WebApp.close();
    });
  </script>
</body>
</html>

